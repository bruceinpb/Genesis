<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Genesis 2">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="iPad-centric writing studio for crafting world-class, best-seller prose.">

  <title>Genesis 2 — Prose Studio</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">

  <link rel="stylesheet" href="css/main.css">
</head>
<body class="no-bounce">

<!-- ===== Landing Page ===== -->
<div id="landing-page">
  <!-- User Selection Step -->
  <div class="landing-view" id="landing-user-select">
    <div class="landing-center">
      <div class="landing-logo">
        <h1>Genesis 2</h1>
        <p>Prose Studio</p>
      </div>
      <div class="landing-card">
        <h2>Who's Writing Today?</h2>
        <div id="user-list" class="user-list"></div>
        <div class="landing-input-row">
          <input type="text" id="new-user-name" class="form-input" placeholder="Enter your name..." autocomplete="off">
          <button class="btn btn-primary" id="btn-user-continue">Go</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Selection Step -->
  <div class="landing-view" id="landing-projects" style="display:none;">
    <div class="landing-top-bar">
      <div class="landing-top-left">
        <h1 class="landing-title">Genesis 2</h1>
        <span class="landing-welcome">Welcome, <span id="landing-user-name"></span></span>
      </div>
      <button class="btn btn-sm" id="btn-change-user" data-tooltip="Switch User — Return to the user selection screen to sign in as a different writer. Your current work is saved automatically.">Switch User</button>
    </div>

    <div class="landing-body">
      <button class="btn btn-primary landing-create-btn" id="btn-create-project" data-tooltip="Create New Project — Start a new writing project. You'll set a title, genre, and word count goal. Each project has its own chapters, characters, notes, and cover image.">
        + Create New Project
      </button>

      <div class="projects-section" id="my-projects-section">
        <h3>Your Projects</h3>
        <div id="my-projects-list" class="project-grid"></div>
      </div>

      <div class="projects-section" id="others-projects-section" style="display:none;">
        <h3>All Projects</h3>
        <div id="others-projects-list" class="project-grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== App (hidden until a project is opened) ===== -->
<div id="app" style="display:none;">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Genesis 2</h1>
      <button class="toolbar-btn" id="btn-sidebar-toggle" aria-label="Close sidebar" data-tooltip="Show or hide the sidebar panel containing chapters, characters, notes, and your book cover image.">&#9776;</button>
    </div>

    <div class="sidebar-setup-book">
      <button class="setup-book-pill" id="btn-book-structure" data-tooltip="Setup Book — Configure the overall structure of your book: total words, number of chapters, subtitle, and generate AI-powered chapter outlines.">Setup Book</button>
    </div>

    <nav class="sidebar-nav">
      <button class="active" data-tab="chapters" data-tooltip="Chapters — View and manage your book's chapters. Tap a chapter to edit it. Use '+ Chapter' at the bottom to add new chapters. Drag to reorder.">Chapters</button>
      <button data-tab="characters" data-tooltip="Characters — Create and manage character profiles with names, roles, descriptions, and personality traits. Character details are automatically used as context when generating AI prose.">Characters</button>
      <button data-tab="notes" data-tooltip="Notes — Keep research notes, plot outlines, world-building details, and reference material organized alongside your manuscript. Notes are saved per project.">Notes</button>
    </nav>

    <div id="sidebar-cover" class="sidebar-cover">
      <div id="cover-image-container" class="cover-image-container">
        <div id="cover-placeholder" class="cover-placeholder">
          <span>No Cover</span>
          <button class="btn btn-sm" id="btn-create-cover" data-tooltip="Generate an AI-powered book cover image. Claude analyzes your story's content and genre to create an image prompt, then Hugging Face AI models generate the artwork. Requires a free HF API token in Settings.">Create Cover</button>
        </div>
        <img id="cover-image" class="cover-image" style="display:none;" alt="Book cover">
        <div id="cover-loading" class="cover-loading" style="display:none;">Generating...</div>
      </div>
      <button class="btn btn-sm" id="btn-regenerate-cover" data-tooltip="Generate a new AI cover image, replacing the current one. Each regeneration creates a unique image based on your story's content and genre." style="display:none; width:100%; margin-top:6px;">Regenerate Cover</button>
    </div>

    <div class="sidebar-content">
      <div class="sidebar-panel" id="sidebar-chapters" style="display:block;">
        <!-- Chapter list rendered by JS -->
      </div>
      <div class="sidebar-panel" id="sidebar-characters" style="display:none;">
        <!-- Characters list rendered by JS -->
      </div>
      <div class="sidebar-panel" id="sidebar-notes" style="display:none;">
        <!-- Notes list rendered by JS -->
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn btn-sm" id="btn-switch-user-sidebar" data-tooltip="Switch User — Sign out of the current user profile and return to the user selection screen. All your work is saved automatically to the cloud." style="flex:1; margin-bottom:6px;">
        &#x1F464; Switch User
      </button>
      <button class="btn btn-sm" id="btn-back-to-projects-sidebar" data-tooltip="All Projects — Return to the project list where you can open a different project, create a new one, or see projects from other users." style="flex:1; margin-bottom:6px;">
        &#8592; All Projects
      </button>
      <button class="btn btn-sm" id="btn-delete-project-sidebar" data-tooltip="Delete Project — Permanently delete this entire project and all its chapters, characters, notes, and cover image. This cannot be undone." style="flex:1; border-color:var(--danger); color:var(--danger);">
        &#x2715; Delete Project
      </button>
    </div>
  </aside>

  <!-- ===== Toolbar ===== -->
  <header class="toolbar">
    <button class="toolbar-btn" id="btn-sidebar-toggle-mobile" aria-label="Menu" data-tooltip="Show or hide the sidebar panel containing chapters, characters, notes, and your book cover image.">&#9776;</button>

    <button class="toolbar-btn" id="btn-back-to-projects" data-tooltip="Return to the project selection screen to open a different project or create a new one.">&#8592;</button>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-bold" data-tooltip="Bold — Make selected text bold to emphasize important words or phrases. Keyboard shortcut: Cmd+B."><b>B</b></button>
      <button class="toolbar-btn" id="btn-italic" data-tooltip="Italic — Make selected text italic. Used for emphasis, internal thoughts, or foreign words. Keyboard shortcut: Cmd+I."><i>I</i></button>
      <button class="toolbar-btn" id="btn-heading" data-tooltip="Heading — Insert a heading at the cursor position. Use for chapter titles or major section breaks within your manuscript.">H</button>
      <button class="toolbar-btn" id="btn-blockquote" data-tooltip="Blockquote — Format selected text as an indented block quote. Useful for letters, signs, poems, or quoted passages within your story.">&#8220;</button>
      <button class="toolbar-btn" id="btn-scene-break" data-tooltip="Scene Break — Insert a scene break marker (***). Use to mark a shift in time, location, or point of view within a chapter.">***</button>
    </div>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-undo" data-tooltip="Undo — Reverse your most recent edit. Tap multiple times to undo several changes in sequence.">&#8617;</button>
      <button class="toolbar-btn" id="btn-redo" data-tooltip="Redo — Restore a change you just undid. Tap multiple times to redo several undone changes.">&#8618;</button>
    </div>

    <span class="toolbar-title" id="project-title">Genesis 2</span>
    <span class="toolbar-title" id="scene-title" style="font-weight:400;font-size:0.85rem;color:var(--text-secondary);"></span>

    <div class="toolbar-spacer"></div>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-generate" data-tooltip="AI Prose Generator — Open the AI writing assistant. Describe your scene and Claude will generate prose that matches your story's voice, style, and characters." style="color:var(--accent-primary);font-weight:700;">AI</button>
      <button class="toolbar-btn" id="btn-analysis" data-tooltip="Prose Analysis — Analyze your current chapter for writing quality, pacing, dialogue balance, sentence variety, and prose style. Provides detailed feedback and suggestions from Claude AI.">&#9874;</button>
      <button class="toolbar-btn" id="btn-export" data-tooltip="Export — Export your manuscript in multiple formats: Standard Manuscript (Shunn format for agent/publisher submissions), Styled HTML, Plain Text, Full JSON Backup, or download your cover image.">&#8681;</button>
      <button class="toolbar-btn" id="btn-focus-mode" data-tooltip="Focus Mode — Enter distraction-free writing mode. Hides the sidebar, toolbar, and status bar so you can concentrate entirely on your prose. Tap the menu icon to exit.">&#9673;</button>
      <button class="toolbar-btn" id="btn-settings" data-tooltip="Settings — Configure your writing environment: appearance themes, AI model selection, API keys, daily writing goals, and project-specific settings like title, genre, and word count targets.">&#9881;</button>
    </div>
  </header>

  <!-- ===== Editor ===== -->
  <main class="editor-area">
    <div class="editor-container">
      <div id="chapter-outline-display" class="chapter-outline-section" style="display:none;">
        <h4>Chapter Outline</h4>
        <p id="chapter-outline-text"></p>
      </div>
      <div id="editor" class="editor" data-placeholder="Begin writing your story..."></div>
      <div id="welcome-overlay" class="welcome" style="display:none;">
        <h2>Genesis 2</h2>
        <p>
          A writing studio crafted for creating world-class, best-seller prose.
          Designed for iPad, built for serious writers.
        </p>
        <button class="btn btn-primary" id="btn-new-project">Create New Project</button>
        <div style="margin-top:16px;">
          <button class="btn btn-sm" id="btn-import-project">Import Existing Project</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ===== Floating Word Count ===== -->
  <div class="floating-word-count" id="floating-word-count">
    <span id="fwc-words">0</span> words
    <span class="fwc-divider">|</span>
    <span id="fwc-total">0</span> total
    <span class="fwc-divider">|</span>
    <span id="fwc-progress">0%</span>
  </div>

  <!-- ===== Continue Writing Bar ===== -->
  <div class="continue-bar" id="continue-bar" style="display:none;">
    <div class="continue-group" style="display:flex;gap:4px;flex:1;">
      <button class="btn btn-primary continue-word-btn" data-words="500" data-tooltip="Continue Writing ~500 words — Generate approximately 500 words of new prose, continuing from where the story left off." style="flex:1;">+500</button>
      <button class="btn btn-primary continue-word-btn" data-words="1000" data-tooltip="Continue Writing ~1,000 words — Generate approximately 1,000 words of new prose, continuing from where the story left off." style="flex:1;">+1,000</button>
      <button class="btn btn-primary continue-word-btn" data-words="2000" data-tooltip="Continue Writing ~2,000 words — Generate approximately 2,000 words of new prose, continuing from where the story left off." style="flex:1;">+2,000</button>
    </div>
    <button class="btn" id="btn-continue-rethink" data-tooltip="Rethink — Revise the current chapter's outline based on your instructions before continuing to write." style="font-size:0.8rem;">Rethink</button>
    <button class="btn" id="btn-continue-to-target" data-tooltip="Write to Goal — Calculate the remaining words needed to reach your project's word count goal, then generate prose to complete the story with a satisfying conclusion.">Write to Goal</button>
    <button class="btn btn-sm" id="btn-continue-dismiss" data-tooltip="Dismiss this bar." style="min-width:44px;">&times;</button>
  </div>

  <!-- ===== Status Bar ===== -->
  <footer class="status-bar">
    <div class="status-item" data-tooltip="Chapter Words — The word count for the chapter you are currently editing.">
      <span class="label">Words:</span>
      <span class="value" id="status-words">0</span>
    </div>
    <div class="status-item" data-tooltip="Total Words — The combined word count across all chapters in this project.">
      <span class="label">Total:</span>
      <span class="value" id="status-total">0</span>
    </div>
    <div class="status-item" data-tooltip="Manuscript Goal — Your target total word count for the finished manuscript. Change this in Settings under Project Settings.">
      <span class="label">Goal:</span>
      <span class="value" id="status-goal">80,000</span>
    </div>
    <div class="status-item" data-tooltip="Progress — The percentage of your manuscript word count goal that has been completed so far.">
      <span class="label">Progress:</span>
      <span class="value" id="status-progress">0%</span>
    </div>

    <div class="status-spacer"></div>

    <div class="status-item" data-tooltip="Today's Writing — Words written today versus your daily writing goal. Resets at midnight. Set your daily goal in Settings.">
      <span class="label">Today:</span>
      <span class="value" id="status-daily">0 / 1,000</span>
    </div>
  </footer>

</div>

<!-- ===== Focus Mode Exit Button (must be outside #app grid to work on iPad Safari) ===== -->
<button class="focus-exit-btn" id="btn-exit-focus" data-tooltip="Exit Focus Mode — Return to the full editor view with sidebar, toolbar, and status bar visible.">&#9776;</button>

<!-- ===== Panel Overlay ===== -->
<div class="panel-overlay" id="panel-overlay"></div>

<!-- ===== Analysis Panel ===== -->
<div class="panel" id="panel-analysis">
  <div class="panel-header">
    <h2>Prose Analysis</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-analysis-body">
    <!-- Rendered dynamically -->
  </div>
</div>

<!-- ===== Export Panel ===== -->
<div class="panel" id="panel-export">
  <div class="panel-header">
    <h2>Export Manuscript</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body">
    <div class="analysis-section">
      <h3>Export Formats</h3>
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">
        Export your manuscript in various formats for submission, sharing, or backup.
      </p>

      <button class="btn" id="export-manuscript" data-tooltip="Export in standard Shunn manuscript format: Courier 12pt, double-spaced, with proper headers and page breaks. This is the industry-standard format required by most literary agents and publishers for submissions." style="width:100%;margin-bottom:8px;">
        Standard Manuscript Format (HTML)
        <br><span style="font-size:0.75rem;color:var(--text-muted);">Courier 12pt, double-spaced, Shunn format</span>
      </button>

      <button class="btn" id="export-html" data-tooltip="Export as a beautifully formatted HTML document with clean typography. Ideal for reading on screen, sharing with beta readers, or printing a polished copy." style="width:100%;margin-bottom:8px;">
        Styled HTML
        <br><span style="font-size:0.75rem;color:var(--text-muted);">Beautiful reading format</span>
      </button>

      <button class="btn" id="export-plain" data-tooltip="Export as a universal plain text (.txt) file. Compatible with any text editor, word processor, or e-reader. All formatting is stripped to just raw text." style="width:100%;margin-bottom:8px;">
        Plain Text
        <br><span style="font-size:0.75rem;color:var(--text-muted);">Universal .txt format</span>
      </button>

      <button class="btn" id="export-json" data-tooltip="Export a complete JSON backup of your entire project: all chapters, characters, notes, cover image, and project settings. Use this to create full backups or transfer your project between devices." style="width:100%;margin-bottom:8px;">
        Full Backup (JSON)
        <br><span style="font-size:0.75rem;color:var(--text-muted);">Everything including chapters</span>
      </button>
    </div>

    <div class="analysis-section" id="export-cover-section" style="display:none;">
      <h3>Cover Image</h3>
      <img id="export-cover-preview" class="export-cover-preview" style="display:none;" alt="Cover preview">
      <button class="btn" id="export-cover-download" data-tooltip="Download your AI-generated book cover as a high-resolution image file. Suitable for use in e-book publishing, print covers, or promotional materials." style="width:100%;margin-bottom:8px;">
        Download Cover Image (PNG)
        <br><span style="font-size:0.75rem;color:var(--text-muted);">High resolution book cover</span>
      </button>
    </div>

    <div class="analysis-section">
      <h3>Print</h3>
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Use your browser's print function (Cmd+P) for a clean manuscript printout.
      </p>
    </div>
  </div>
</div>

<!-- ===== Generate Panel ===== -->
<div class="panel" id="panel-generate">
  <div class="panel-header">
    <h2>AI Prose Generator</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-generate-body">
    <div class="analysis-section">
      <h3>Story Plot / Prompt</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">
        Describe what should happen in this scene. The more detail you provide, the better the output.
      </p>
      <textarea class="form-input" id="generate-plot" rows="6" data-tooltip="Describe what happens in this scene. Include character actions, dialogue hints, emotional beats, and setting details. The more specific and detailed your description, the better the AI-generated prose will be." placeholder="e.g. Sarah discovers a hidden letter in her grandmother's attic that reveals a family secret. She confronts her mother about it over dinner. Tension builds as her mother tries to deflect..."></textarea>
    </div>

    <div class="analysis-section">
      <h3>Options</h3>
      <div class="form-group">
        <label>Approximate Words</label>
        <select class="form-input" id="generate-word-target" data-tooltip="Choose how much prose to generate. Short scenes (~250 words) for brief moments or transitions. Standard (~500) for typical scenes. Long (~1,000) for detailed, multi-beat scenes. Full chapter (~2,000) for complete chapter drafts.">
          <option value="250">~250 (short scene)</option>
          <option value="500" selected>~500 (standard scene)</option>
          <option value="1000">~1,000 (long scene)</option>
          <option value="2000">~2,000 (full chapter)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tone (optional)</label>
        <input type="text" class="form-input" id="generate-tone" data-tooltip="Set the emotional tone for this scene. Examples: dark and foreboding, lighthearted and humorous, tense and suspenseful, melancholic, lyrical and literary. Leave blank to let the AI match your existing tone." placeholder="e.g. dark, humorous, suspenseful, literary">
      </div>
      <div class="form-group">
        <label>Style Inspiration (optional)</label>
        <input type="text" class="form-input" id="generate-style" data-tooltip="Name an author whose writing style you'd like the AI to emulate. The AI will adapt its prose style, sentence structure, and vocabulary to match. Examples: Cormac McCarthy, Donna Tartt, Stephen King. Leave blank for a neutral literary style." placeholder="e.g. Cormac McCarthy, Donna Tartt, Stephen King">
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="generate-continue" checked style="width:20px;height:20px;">
        <label for="generate-continue" style="margin:0;" data-tooltip="When checked, the AI reads your existing text in the editor and continues seamlessly from where you left off, matching your established voice and narrative flow. Uncheck to generate a standalone passage.">Continue from existing text in editor</label>
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="generate-use-characters" checked style="width:20px;height:20px;">
        <label for="generate-use-characters" style="margin:0;" data-tooltip="When checked, the AI uses your character profiles (names, descriptions, roles, and personalities from the Characters tab) to keep characters consistent and in-character throughout the generated prose.">Include character profiles as context</label>
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="generate-use-notes" checked style="width:20px;height:20px;">
        <label for="generate-use-notes" style="margin:0;" data-tooltip="When checked, the AI reads all your project notes (research, worldbuilding, plot notes) from the Notes tab and uses them as context to produce more accurate, on-topic prose.">Include project notes as context</label>
      </div>
    </div>

    <div class="analysis-section">
      <h3>AI Instructions</h3>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">
        Persistent rules the AI must follow for every generation in this project. These are given high priority in the prompt.
      </p>
      <textarea class="form-input" id="generate-ai-instructions" rows="4" data-tooltip="Enter rules or constraints the AI must follow for every prose generation. Examples: 'Each chapter covers 10 years of the protagonist's life', 'Write in first person present tense', 'Never use flashbacks'. These instructions are saved with the project and strongly emphasized in the AI prompt." placeholder="e.g. Each chapter covers exactly 10 years. Chapter 1 covers 1863-1873. Write in a formal, historical narrative style. Focus on factual events and real historical details."></textarea>
      <button class="btn btn-sm" id="btn-save-ai-instructions" data-tooltip="Save these AI instructions to your project so they persist across sessions." style="width:100%;margin-top:6px;">Save Instructions</button>
    </div>

    <div id="generate-status" style="display:none;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="generate-spinner"></div>
        <span id="generate-status-text" style="font-size:0.85rem;color:var(--accent-primary);">Generating...</span>
      </div>
    </div>

    <div id="generate-error" style="display:none;margin-bottom:16px;padding:12px;background:rgba(255,59,48,0.1);border-radius:var(--radius-sm);color:var(--danger);font-size:0.85rem;"></div>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" id="btn-generate-prose" data-tooltip="Generate Prose — Send your scene description to Claude AI. The generated prose will be appended to your current chapter in the editor. You can edit, revise, or regenerate as needed." style="flex:1;">Generate Prose</button>
      <button class="btn" id="btn-generate-cancel" data-tooltip="Stop — Cancel the current AI generation. Any prose already received will remain in the editor." style="display:none;">Stop</button>
    </div>

    <div id="generate-no-key" style="display:none;margin-top:16px;padding:16px;background:var(--bg-secondary);border-radius:var(--radius-md);text-align:center;">
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        You need an Anthropic API key to generate prose.
      </p>
      <button class="btn btn-sm btn-primary" id="btn-generate-open-settings">Open Settings to Add Key</button>
    </div>
  </div>
</div>

<!-- ===== Book Structure Panel ===== -->
<div class="panel" id="panel-book-structure">
  <div class="panel-header">
    <h2>Book Structure</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-book-structure-body">
    <div class="analysis-section">
      <h3>Book Details</h3>
      <div class="form-group">
        <label>Book Title</label>
        <input type="text" class="form-input" id="bs-title" placeholder="Your book title">
      </div>
      <div class="form-group">
        <label>Subtitle (optional)</label>
        <input type="text" class="form-input" id="bs-subtitle" placeholder="A subtitle for your book">
        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">If set, the subtitle appears on the cover image below the title in smaller text.</p>
      </div>
    </div>

    <div class="analysis-section">
      <h3>Book Size</h3>
      <div class="form-group">
        <label>Total Word Count Goal</label>
        <input type="number" class="form-input" id="bs-total-words" value="80000" min="5000" step="1000" placeholder="80000">
      </div>
      <div class="form-group">
        <label>Number of Chapters</label>
        <input type="number" class="form-input" id="bs-num-chapters" value="20" min="1" max="200" placeholder="20">
      </div>
      <div class="form-group" style="margin-top:12px;">
        <div class="stat-card" style="text-align:center;">
          <div class="stat-value" id="bs-words-per-chapter">4,000</div>
          <div class="stat-label">Approximate Words per Chapter</div>
        </div>
      </div>
      <button class="btn btn-primary" id="btn-save-book-structure" style="width:100%;margin-top:12px;">Save Book Structure</button>
    </div>

    <div class="analysis-section">
      <h3>AI Outline Generation</h3>
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Generate a detailed outline for each chapter based on your notes, characters, and book structure.
        The AI will analyze all your project information and create ~200-250 word outlines per chapter,
        auto-name each chapter, and populate the sidebar. Review and edit outlines before generating prose.
      </p>
      <div id="bs-outline-status" style="display:none;margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span id="bs-outline-status-text" style="font-size:0.85rem;color:var(--accent-primary);">Generating outlines...</span>
        </div>
      </div>
      <div id="bs-outline-error" style="display:none;margin-bottom:12px;padding:12px;background:rgba(255,59,48,0.1);border-radius:var(--radius-sm);color:var(--danger);font-size:0.85rem;"></div>
      <button class="btn btn-primary" id="btn-generate-outlines" style="width:100%;">Generate Outlines</button>
      <p style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">
        This will create chapters with outlines. Existing chapters will not be affected. Make sure you have entered notes, characters, and book structure information first.
      </p>
    </div>
  </div>
</div>

<!-- ===== Prose Review Modal ===== -->
<div class="modal-overlay" id="prose-review-overlay">
  <div class="modal" style="width:min(600px, 90vw);max-height:90vh;">
    <div class="modal-header">
      <h2>Prose Quality Review</h2>
    </div>
    <div class="modal-body" id="prose-review-body" style="overflow-y:auto;">
      <!-- Rendered dynamically -->
    </div>
    <div class="modal-footer" style="flex-wrap:wrap;gap:8px;">
      <div style="display:flex;gap:4px;width:100%;margin-bottom:4px;">
        <button class="btn btn-primary continue-word-btn" data-words="500" style="flex:1;font-size:0.8rem;">+500</button>
        <button class="btn btn-primary continue-word-btn" data-words="1000" style="flex:1;font-size:0.8rem;">+1,000</button>
        <button class="btn btn-primary continue-word-btn" data-words="2000" style="flex:1;font-size:0.8rem;">+2,000</button>
        <button class="btn" id="btn-prose-review-rethink" style="font-size:0.8rem;">Rethink</button>
      </div>
      <div style="display:flex;gap:8px;width:100%;">
        <button class="btn" id="btn-prose-review-accept" style="flex:1;">Accept Prose</button>
        <button class="btn btn-primary" id="btn-prose-review-rewrite" style="flex:1;">Rewrite Problem Areas</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Rethink Modal ===== -->
<div class="modal-overlay" id="rethink-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Rethink Chapter Outline</h2>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Provide instructions for how the chapter outline should be revised. The AI will rewrite the outline based on your guidance.
      </p>
      <textarea class="form-input" id="rethink-prompt" rows="4" placeholder='e.g. "Enhance character X\'s role in this chapter" or "Do not discuss X, Y, or Z"'></textarea>
      <div id="rethink-status" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span style="font-size:0.85rem;color:var(--accent-primary);">Rethinking outline...</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-rethink-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-rethink-submit">Rethink</button>
    </div>
  </div>
</div>

<!-- ===== New Project Help Modal ===== -->
<div class="modal-overlay" id="new-project-help-overlay">
  <div class="modal new-project-help-modal">
    <div class="modal-header">
      <h2>Welcome to Genesis 2</h2>
    </div>
    <div class="modal-body" style="overflow-y:auto;">
      <p style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;line-height:1.7;">
        Genesis 2 is a complete writing studio designed to help you craft world-class prose from concept to finished manuscript. Here's how to get started with your new project:
      </p>

      <div class="help-step">
        <div class="help-step-number">1</div>
        <div class="help-step-content">
          <h3>Set Up Your Book Structure</h3>
          <p>Start by tapping the <strong>Setup Book</strong> button in the sidebar. Here you'll define your book's total word count goal and number of chapters. Genesis will calculate the approximate words per chapter to help you plan your pacing. You can also choose a narrative structure template (Three-Act, Hero's Journey, etc.) to guide your story's pacing.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">2</div>
        <div class="help-step-content">
          <h3>Create Your Characters</h3>
          <p>Switch to the <strong>Characters</strong> tab to build detailed character profiles. Add names, roles, descriptions, motivations, and character arcs. These profiles are automatically fed to the AI when generating prose, ensuring your characters stay consistent throughout the story.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">3</div>
        <div class="help-step-content">
          <h3>Add Notes &amp; Research</h3>
          <p>Use the <strong>Notes</strong> tab to organize your story's foundation. Create notes for:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li><strong>Story Plot</strong> — Outline major plot points, twists, and the arc of your narrative</li>
            <li><strong>World Building</strong> — Detail settings, rules, history, and the world your characters inhabit</li>
            <li><strong>General Notes</strong> — Keep track of themes, tone, timelines, and style preferences</li>
            <li><strong>Research</strong> — Store reference material, historical facts, and technical details for accuracy</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">4</div>
        <div class="help-step-content">
          <h3>Configure Project Settings</h3>
          <p>Tap the <strong>gear icon</strong> (&#9881;) in the toolbar to access Settings. Under Project Settings you can:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li>Set your book's <strong>title</strong> and <strong>subtitle</strong></li>
            <li>Choose a <strong>genre</strong> and <strong>sub-genre</strong> to guide the AI's writing style</li>
            <li>View and change your <strong>story structure</strong> template and track pacing progress</li>
            <li>Add a persistent <strong>AI prompt</strong> that carries across all chapters — use this for rules like point of view, tense, or stylistic constraints</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">5</div>
        <div class="help-step-content">
          <h3>Generate Chapter Outlines</h3>
          <p>Once your structure, characters, and notes are in place, open <strong>Setup Book</strong> and use <strong>Generate Outlines</strong>. The AI will analyze everything you've entered and create detailed outlines for each chapter, giving you a roadmap for your entire book.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">6</div>
        <div class="help-step-content">
          <h3>Write &amp; Generate Prose</h3>
          <p>Select any chapter from the sidebar and start writing. Use the <strong>AI</strong> button in the toolbar to generate prose. You can also select a chapter with an outline and tap <strong>Accept Outline</strong> in the chapter toolbar to auto-generate prose from the outline. Continue writing with the +500, +1000, or +2000 word buttons that appear after each generation.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">7</div>
        <div class="help-step-content">
          <h3>Analyze &amp; Refine</h3>
          <p>Use the <strong>anvil icon</strong> (&#9874;) in the toolbar for prose analysis to check quality, pacing, and style. The AI scores your prose and highlights areas for improvement. Use the <strong>Rewrite</strong> and <strong>Rethink</strong> tools to iterate and polish your manuscript to a professional standard.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">8</div>
        <div class="help-step-content">
          <h3>Generate a Book Cover</h3>
          <p>Once you have prose written, the sidebar displays a cover area. Tap <strong>Create Cover</strong> to generate an AI-powered book cover image based on your story's content and genre. You can regenerate it as many times as you like until you're satisfied. A Hugging Face API token is required (free tier available) — add it in Settings.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">9</div>
        <div class="help-step-content">
          <h3>Export Your Manuscript</h3>
          <p>When you're ready, tap the <strong>export icon</strong> (&#8681;) to export in multiple formats: Standard Manuscript (Shunn format for agents/publishers), Styled HTML, Plain Text, or a full JSON backup. You can also download your cover image separately.</p>
        </div>
      </div>

      <div style="background:var(--bg-secondary);border-radius:var(--radius-md);padding:16px;margin-top:20px;">
        <h3 style="font-size:0.85rem;font-weight:600;color:var(--accent-primary);margin-bottom:8px;">Tips for Best Results</h3>
        <ul style="margin:0 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.8;">
          <li>The more detail you put into characters, notes, and outlines, the better the AI prose will be</li>
          <li>Use the AI Instructions field (in the AI panel) for persistent rules the AI must follow in every generation</li>
          <li>Use the chapter toolbar's <strong>Select All</strong> and <strong>Delete Selected</strong> to manage chapters in bulk</li>
          <li>Set a daily writing goal in Settings to track your progress and build a consistent habit</li>
          <li>Use Focus Mode (&#9673;) to remove all distractions when you need to concentrate</li>
          <li>Your work is saved automatically — both locally and to the cloud</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-primary" id="btn-help-create-project" style="padding:14px 48px;font-size:1rem;">Create Project Now</button>
    </div>
  </div>
</div>

<!-- ===== New Project Creation Modal ===== -->
<div class="modal-overlay" id="new-project-overlay">
  <div class="modal" style="width:min(520px, 90vw);max-height:90vh;">
    <div class="modal-header">
      <h2>Create New Project</h2>
    </div>
    <div class="modal-body" style="overflow-y:auto;">
      <div class="form-group">
        <label>Project Title</label>
        <input type="text" class="form-input" id="new-project-title" placeholder="My Novel" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Genre</label>
        <select class="form-input" id="new-project-genre">
          <option value="">— Select Genre (optional) —</option>
        </select>
      </div>
      <div class="form-group" id="new-project-subgenre-group" style="display:none;">
        <label>Subgenre</label>
        <select class="form-input" id="new-project-subgenre">
          <option value="">— None —</option>
        </select>
      </div>
      <div class="form-group">
        <label>Word Count Goal</label>
        <input type="number" class="form-input" id="new-project-word-goal" value="80000" min="1000" step="1000">
      </div>
      <div class="form-group">
        <label>Story Structure</label>
        <select class="form-input" id="new-project-structure">
          <!-- Populated dynamically -->
        </select>
        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
          Choose a narrative structure template to guide your story's pacing. Select "User / AI Created Outline" if you prefer to define your own chapter-by-chapter outline.
        </p>
      </div>

      <div style="margin-top:16px;padding:14px;background:var(--bg-secondary);border-radius:var(--radius-md);border-left:3px solid var(--accent-primary);">
        <p style="font-size:0.9rem;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Before You Start Writing</p>
        <p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;">
          After creating your project, fill out the AI section for best results:
        </p>
        <ul style="font-size:0.85rem;color:var(--text-secondary);line-height:1.8;margin:8px 0 0 16px;">
          <li><strong>Characters</strong> — Add profiles with names, roles, and descriptions</li>
          <li><strong>Notes</strong> — Add world-building details, plot notes, and research</li>
          <li><strong>AI Instructions</strong> — Set persistent rules for prose generation (in the AI panel)</li>
          <li><strong>Genre &amp; Style</strong> — Configure in Settings for genre-specific prose rules</li>
        </ul>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">
          The more context you provide, the better the AI-generated prose will be.
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-new-project-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-new-project-accept">Accept &amp; Continue</button>
    </div>
  </div>
</div>

<!-- ===== Accept Chapter Outline Confirmation Modal ===== -->
<div class="modal-overlay" id="accept-outline-overlay">
  <div class="modal" style="width:min(440px, 90vw);">
    <div class="modal-header">
      <h2>Have You Entered AI Data?</h2>
    </div>
    <div class="modal-body">
      <p style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">
        Before generating prose, please confirm you have filled out the necessary information in the AI section of the program:
      </p>
      <ul style="font-size:0.85rem;color:var(--text-secondary);line-height:1.8;margin:12px 0 0 16px;">
        <li>Characters and their profiles</li>
        <li>Project notes and world-building details</li>
        <li>AI instructions and writing preferences</li>
        <li>Genre and style settings</li>
      </ul>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-accept-outline-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-accept-outline-continue">Continue</button>
    </div>
  </div>
</div>

<!-- ===== Prose Rethink Modal ===== -->
<div class="modal-overlay" id="prose-rethink-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Rethink Prose</h2>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Describe how the prose should be revised. The AI will rewrite the prose based on your instructions while keeping the same story events and characters.
      </p>
      <textarea class="form-input" id="prose-rethink-prompt" rows="4" placeholder='e.g. "Make the dialogue more natural" or "Add more sensory detail to the opening scene" or "Reduce the purple prose"'></textarea>
      <div id="prose-rethink-status" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span style="font-size:0.85rem;color:var(--accent-primary);">Rewriting prose...</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-prose-rethink-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-prose-rethink-submit">Rewrite</button>
    </div>
  </div>
</div>

<!-- ===== Settings Panel ===== -->
<div class="panel" id="panel-settings">
  <div class="panel-header">
    <h2>Settings</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-settings-body">
    <!-- Rendered dynamically -->
  </div>
</div>

<!-- Flyout Tooltip -->
<div id="tooltip-flyout"><div class="tooltip-body"></div></div>

<script src="https://js.puter.com/v2/"></script>
<script src="js/genres.js"></script>
<script type="module" src="js/app.js"></script>

</body>
</html>
