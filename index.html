<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Genesis 2">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="iPad-centric writing studio for crafting world-class, best-seller prose.">

  <title>Genesis 2 — Prose Studio</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">

  <link rel="stylesheet" href="css/main.css">
</head>
<body class="no-bounce">

<!-- ===== Landing Page ===== -->
<div id="landing-page">
  <!-- User Selection Step -->
  <div class="landing-view" id="landing-user-select">
    <div class="landing-center">
      <div class="landing-logo">
        <h1>Genesis 2</h1>
        <p>Prose Studio</p>
      </div>
      <div class="landing-card">
        <h2>Who's Writing Today?</h2>
        <div id="user-list" class="user-list"></div>
        <div class="landing-input-row">
          <input type="text" id="new-user-name" class="form-input" placeholder="Enter your name..." autocomplete="off">
          <button class="btn btn-primary" id="btn-user-continue">Go</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Selection Step -->
  <div class="landing-view" id="landing-projects" style="display:none;">
    <div class="landing-top-bar">
      <div class="landing-top-left">
        <h1 class="landing-title">Genesis 2</h1>
        <span class="landing-welcome">Welcome, <span id="landing-user-name"></span></span>
      </div>
      <button class="btn btn-sm" id="btn-change-user" data-tooltip="Switch User — Return to the user selection screen to sign in as a different writer. Your current work is saved automatically.">Switch User</button>
    </div>

    <div class="landing-body">
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary landing-create-btn" id="btn-create-project" data-tooltip="Create New Project — Start a new writing project. You'll set a title, genre, and word count goal. Each project has its own chapters, characters, notes, and cover image.">
          + Create New Project
        </button>
        <button class="btn landing-create-btn" id="btn-import-project-landing" data-tooltip="Import Existing Project — Import a manuscript from a .md, .docx, or .epub file. Chapters are automatically detected and created.">
          &#8681; Import Project
        </button>
        <input type="file" id="import-project-file-landing" accept=".md,.docx,.epub" style="display:none;">
      </div>

      <div class="projects-section" id="my-projects-section">
        <h3>Your Projects</h3>
        <div id="my-projects-list" class="project-grid"></div>
      </div>

      <div class="projects-section" id="others-projects-section" style="display:none;">
        <h3>All Projects</h3>
        <div id="others-projects-list" class="project-grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== App (hidden until a project is opened) ===== -->
<div id="app" style="display:none;">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Genesis 2</h1>
      <button class="toolbar-btn" id="btn-sidebar-toggle" aria-label="Close sidebar" data-tooltip="Show or hide the sidebar panel containing chapters, characters, notes, and your book cover image.">&#9776;</button>
    </div>

    <div class="sidebar-setup-book">
      <button class="setup-book-pill" id="btn-book-structure" data-tooltip="Setup Book — Configure the overall structure of your book: total words, number of chapters, subtitle, quality threshold for AI generation, and generate AI-powered chapter outlines.">Setup Book</button>
    </div>

    <nav class="sidebar-nav">
      <button class="active" data-tab="characters" data-tooltip="Characters — Create and manage character profiles with names, roles, descriptions, and personality traits. Character details are automatically used as context when generating AI prose.">Characters</button>
      <button data-tab="notes" data-tooltip="Notes — Keep research notes, plot outlines, world-building details, and reference material organized alongside your manuscript. Notes are saved per project.">Notes</button>
    </nav>

    <div id="sidebar-cover" class="sidebar-cover">
      <div id="cover-image-container" class="cover-image-container">
        <div id="cover-placeholder" class="cover-placeholder">
          <span>No Cover</span>
          <button class="btn btn-sm" id="btn-create-cover" data-tooltip="Generate an AI-powered book cover image. Claude analyzes your story's content and genre to create an image prompt, then Hugging Face AI models generate the artwork. Requires a free HF API token in Settings.">Create Cover</button>
        </div>
        <img id="cover-image" class="cover-image" style="display:none;" alt="Book cover">
        <div id="cover-loading" class="cover-loading" style="display:none;">Generating...</div>
      </div>
      <button class="btn btn-sm" id="btn-regenerate-cover" data-tooltip="Generate a new AI cover image, replacing the current one. Each regeneration creates a unique image based on your story's content and genre." style="display:none; width:100%; margin-top:6px;">Regenerate Cover</button>
      <button class="btn btn-sm" id="btn-edit-cover" data-tooltip="Edit the cover image: change title text, subtitle, font style, text placement, and typography settings. Customize your cover to match your vision." style="display:none; width:100%; margin-top:6px;">Edit Cover</button>
    </div>

    <div class="sidebar-content">
      <div class="sidebar-panel" id="sidebar-characters" style="display:block;">
        <!-- Characters list rendered by JS -->
      </div>
      <div class="sidebar-panel" id="sidebar-notes" style="display:none;">
        <!-- Notes list rendered by JS -->
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn btn-sm" id="btn-import-knowledge-sidebar" data-tooltip="Import Knowledge — Import external research materials, Wikipedia articles, or reference documents into this project. Imported knowledge is automatically used as context during AI prose generation." style="flex:1; margin-bottom:6px;">
        &#x1F4DA; Import Knowledge
      </button>
      <button class="btn btn-sm" id="btn-import-project-sidebar" data-tooltip="Import Project — Import a manuscript from a .md, .docx, or .epub file into a new project." style="flex:1; margin-bottom:6px;">
        &#8681; Import Project
      </button>
      <input type="file" id="import-project-file-sidebar" accept=".md,.docx,.epub" style="display:none;">
      <button class="btn btn-sm" id="btn-switch-user-sidebar" data-tooltip="Switch User — Sign out of the current user profile and return to the user selection screen. All your work is saved automatically to the cloud." style="flex:1; margin-bottom:6px;">
        &#x1F464; Switch User
      </button>
      <button class="btn btn-sm" id="btn-back-to-projects-sidebar" data-tooltip="All Projects — Return to the project list where you can open a different project, create a new one, or see projects from other users." style="flex:1;">
        &#8592; All Projects
      </button>
    </div>
  </aside>

  <!-- ===== Chapter Navigator ===== -->
  <div class="chapter-nav" id="chapter-nav">
    <div class="chapter-nav-header">
      <span class="chapter-nav-title">Manuscript</span>
      <div class="chapter-nav-actions">
        <button class="chapter-nav-btn" id="btn-nav-select-all" title="Select All">&#9744;</button>
        <button class="chapter-nav-btn chapter-nav-btn-danger" id="btn-nav-delete-selected" title="Delete Selected" disabled>&#x2715;</button>
        <button class="chapter-nav-btn" id="btn-nav-add-chapter" title="Add Chapter">+</button>
        <button class="chapter-nav-btn" id="btn-nav-collapse" title="Collapse Navigator">&#9666;</button>
      </div>
    </div>
    <div class="chapter-nav-toolbar" id="chapter-nav-toolbar">
      <label class="nav-select-all-label">
        <input type="checkbox" id="nav-toolbar-select-all" title="Select All">
        <span>All</span>
      </label>
      <button class="btn btn-sm nav-toolbar-btn nav-delete-btn" id="btn-nav-toolbar-delete" disabled>Delete</button>
      <button class="btn btn-sm nav-toolbar-btn nav-accept-btn" id="btn-nav-accept-outline">Accept Outline</button>
    </div>
    <div class="chapter-nav-body" id="chapter-nav-body">
      <!-- Front Matter Section -->
      <div class="nav-section" id="nav-section-front">
        <div class="nav-section-header" data-section="front">
          <span class="nav-section-arrow">&#9662;</span>
          <span class="nav-section-label">Front Matter</span>
          <span class="nav-section-count" id="nav-front-count">0</span>
        </div>
        <div class="nav-section-items" id="nav-front-items">
          <!-- Rendered by JS -->
        </div>
      </div>
      <!-- Chapters Section -->
      <div class="nav-section" id="nav-section-chapters">
        <div class="nav-section-header" data-section="chapters">
          <span class="nav-section-arrow">&#9662;</span>
          <span class="nav-section-label">Chapters</span>
          <span class="nav-section-count" id="nav-chapters-count">0</span>
        </div>
        <div class="nav-section-items" id="nav-chapter-items">
          <!-- Rendered by JS -->
        </div>
      </div>
      <!-- Back Matter Section -->
      <div class="nav-section" id="nav-section-back">
        <div class="nav-section-header" data-section="back">
          <span class="nav-section-arrow">&#9662;</span>
          <span class="nav-section-label">Back Matter</span>
          <span class="nav-section-count" id="nav-back-count">0</span>
        </div>
        <div class="nav-section-items" id="nav-back-items">
          <!-- Rendered by JS -->
        </div>
      </div>
    </div>
    <!-- Resize Handle -->
    <div class="chapter-nav-resize" id="chapter-nav-resize"></div>
  </div>

  <!-- ===== Toolbar ===== -->
  <header class="toolbar">
    <button class="toolbar-btn" id="btn-sidebar-toggle-mobile" aria-label="Menu" data-tooltip="Show or hide the sidebar panel containing chapters, characters, notes, and your book cover image.">&#9776;</button>

    <button class="toolbar-btn" id="btn-back-to-projects" data-tooltip="Return to the project selection screen to open a different project or create a new one.">&#8592;</button>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-bold" data-tooltip="Bold — Make selected text bold to emphasize important words or phrases. Keyboard shortcut: Cmd+B."><b>B</b></button>
      <button class="toolbar-btn" id="btn-italic" data-tooltip="Italic — Make selected text italic. Used for emphasis, internal thoughts, or foreign words. Keyboard shortcut: Cmd+I."><i>I</i></button>
      <button class="toolbar-btn" id="btn-heading" data-tooltip="Heading — Insert a Heading 1 at the cursor position. Use for chapter titles (required for KDP table of contents). AI-generated chapters automatically start with an H1 chapter heading.">H</button>
      <button class="toolbar-btn" id="btn-blockquote" data-tooltip="Blockquote — Format selected text as an indented block quote. Useful for letters, signs, poems, or quoted passages within your story.">&#8220;</button>
      <button class="toolbar-btn" id="btn-code" data-tooltip="Code — Toggle inline code/monospace formatting on the selected text. Useful for technical terms or special formatting.">C.</button>
      <button class="toolbar-btn" id="btn-scene-break" data-tooltip="Scene Break — Insert a scene break marker (* * *). Use to mark a shift in time, location, or point of view within a chapter. AI-generated prose automatically includes scene breaks between beats and at chapter endings.">***</button>
    </div>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-undo" data-tooltip="Undo — Reverse your most recent edit. Tap multiple times to undo several changes in sequence.">&#8617;</button>
      <button class="toolbar-btn" id="btn-redo" data-tooltip="Redo — Restore a change you just undid. Tap multiple times to redo several undone changes.">&#8618;</button>
    </div>

    <span class="toolbar-title" id="project-title">Genesis 2</span>
    <span class="toolbar-title" id="scene-title" style="font-weight:400;font-size:0.85rem;color:var(--text-secondary);"></span>

    <button class="toolbar-btn" id="btn-compare-current" style="display:none;font-size:0.75rem;" data-tooltip="Compare with Original — Open a side-by-side view comparing this translated chapter with its original source chapter.">&#8596; Compare</button>

    <div class="toolbar-spacer"></div>

    <div class="toolbar-group">
      <button class="toolbar-btn" id="btn-analysis" data-tooltip="Prose Analysis — Analyze your current chapter for writing quality, pacing, dialogue balance, sentence variety, and prose style. Provides detailed feedback and suggestions from Claude AI.">&#9874;</button>
      <button class="toolbar-btn" id="btn-focus-mode" data-tooltip="Focus Mode — Enter distraction-free writing mode. Hides the sidebar, toolbar, and status bar so you can concentrate entirely on your prose. Tap the menu icon to exit.">&#9673;</button>
      <button class="toolbar-btn" id="btn-help" data-tooltip="Help — View a detailed guide to all features, tools, and workflows available in Genesis 2.">?</button>
    </div>
  </header>

  <!-- ===== Editor ===== -->
  <main class="editor-area" id="editor-area">
    <div class="editor-container" id="editor-container-original">
      <div class="editor-pane-header" id="editor-pane-header-original" style="display:none;">
        <span class="pane-label">Original</span>
        <span class="pane-lang" id="pane-lang-original">English</span>
        <button class="btn btn-sm" id="btn-close-translation" title="Close translation view">&times;</button>
      </div>
      <div id="editor" class="editor" data-placeholder="Begin writing your story..."></div>
      <div id="welcome-overlay" class="welcome" style="display:none;">
        <h2>Genesis 2</h2>
        <p>
          A writing studio crafted for creating world-class, best-seller prose.
          Designed for iPad, built for serious writers.
        </p>
        <button class="btn btn-primary" id="btn-new-project">Create New Project</button>
        <div style="margin-top:16px;">
          <button class="btn btn-sm" id="btn-import-project">Import Existing Project</button>
          <input type="file" id="import-project-file" accept=".md,.docx,.epub" style="display:none;">
        </div>
      </div>
    </div>

    <!-- Translation Pane (hidden by default) -->
    <div class="editor-container translation-pane" id="editor-container-translation" style="display:none;">
      <div class="editor-pane-header">
        <span class="pane-label">Translation</span>
        <span class="pane-lang" id="pane-lang-translation"></span>
        <div class="pane-actions">
          <button class="btn btn-sm" id="btn-translation-copy" title="Copy translation">Copy</button>
          <button class="btn btn-sm" id="btn-translation-export" title="Export translation">Export</button>
        </div>
      </div>
      <div class="translation-progress" id="translation-progress" style="display:none;">
        <div class="translation-progress-bar" id="translation-progress-bar"></div>
        <span class="translation-progress-text" id="translation-progress-text">Translating...</span>
      </div>
      <div id="editor-translation" class="editor" data-placeholder="Translation will appear here..."></div>
    </div>
  </main>

  <!-- ===== Floating Word Count ===== -->
  <div class="floating-word-count" id="floating-word-count">
    <span id="fwc-words">0</span> words
    <span class="fwc-divider">|</span>
    <span id="fwc-total">0</span> total
    <span class="fwc-divider">|</span>
    <span id="fwc-progress">0%</span>
  </div>

  <!-- ===== Continue Writing Bar ===== -->
  <div class="continue-bar" id="continue-bar" style="display:none;">
    <div class="continue-group" style="display:flex;gap:4px;flex:1;">
      <button class="btn btn-primary continue-word-btn" data-words="250" data-tooltip="Continue Writing ~250 words — Generate approximately 250 words of quality-scored prose, continuing from where the story left off." style="flex:1;">+250</button>
      <button class="btn btn-primary continue-word-btn" data-words="500" data-tooltip="Continue Writing ~500 words — Generate approximately 500 words of quality-scored prose, continuing from where the story left off." style="flex:1;">+500</button>
      <button class="btn btn-primary continue-word-btn" data-words="1000" data-tooltip="Continue Writing ~1,000 words — Generate approximately 1,000 words of quality-scored prose, continuing from where the story left off. Prose is scored and refined to meet your quality threshold." style="flex:1;">+1,000</button>
      <button class="btn btn-primary continue-word-btn" data-words="2000" data-tooltip="Continue Writing ~2,000 words — Generate approximately 2,000 words of quality-scored prose in chunks, continuing from where the story left off. Each chunk is scored and refined to meet your quality threshold." style="flex:1;">+2,000</button>
    </div>
    <button class="btn" id="btn-continue-rethink" data-tooltip="Rethink — Revise the current chapter's outline based on your instructions before continuing to write." style="font-size:0.8rem;">Rethink</button>
    <button class="btn" id="btn-continue-to-end" data-tooltip="Write to End — Keep generating prose in passes until the chapter outline is fully covered or the chapter reaches a natural conclusion.">Write to End</button>
    <button class="btn btn-sm" id="btn-continue-dismiss" data-tooltip="Dismiss this bar." style="min-width:44px;">&times;</button>
  </div>

  <!-- ===== Status Bar ===== -->
  <footer class="status-bar">
    <div class="status-item" data-tooltip="Chapter Words — The word count for the chapter you are currently editing.">
      <span class="label">Words:</span>
      <span class="value" id="status-words">0</span>
    </div>
    <div class="status-item" data-tooltip="Total Words — The combined word count across all chapters in this project.">
      <span class="label">Total:</span>
      <span class="value" id="status-total">0</span>
    </div>
    <div class="status-item" data-tooltip="Manuscript Goal — Your target total word count for the finished manuscript. Change this in Settings under Project Settings.">
      <span class="label">Goal:</span>
      <span class="value" id="status-goal">80,000</span>
    </div>
    <div class="status-item" data-tooltip="Progress — The percentage of your manuscript word count goal that has been completed so far.">
      <span class="label">Progress:</span>
      <span class="value" id="status-progress">0%</span>
    </div>

    <div class="status-spacer"></div>
  </footer>

</div>

<!-- ===== Focus Mode Exit Button (must be outside #app grid to work on iPad Safari) ===== -->
<button class="focus-exit-btn" id="btn-exit-focus" data-tooltip="Exit Focus Mode — Return to the full editor view with sidebar, toolbar, and status bar visible.">&#9776;</button>

<!-- ===== Panel Overlay ===== -->
<div class="panel-overlay" id="panel-overlay"></div>

<!-- ===== Analysis Panel ===== -->
<div class="panel" id="panel-analysis">
  <div class="panel-header">
    <h2>Prose Analysis</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-analysis-body">
    <!-- Rendered dynamically -->
  </div>
</div>

<!-- ===== Setup Book Central Modal ===== -->
<div class="modal-overlay" id="setup-book-overlay">
  <div class="modal setup-book-modal">
    <div class="setup-book-header">
      <h2>Setup Book</h2>
      <button class="panel-close" id="btn-close-setup-book" aria-label="Close">&times;</button>
    </div>
    <div class="setup-book-tabs">
      <button class="setup-tab active" data-setup-tab="book"><span class="tab-icon">&#128214;</span> Book Setup</button>
      <button class="setup-tab" data-setup-tab="ai-writer"><span class="tab-icon">&#9998;</span> AI Writer</button>
      <button class="setup-tab" data-setup-tab="translation"><span class="tab-icon">&#127760;</span> Translation</button>
      <button class="setup-tab" data-setup-tab="export"><span class="tab-icon">&#128230;</span> Export</button>
      <button class="setup-tab" data-setup-tab="settings"><span class="tab-icon">&#9881;</span> Settings</button>
    </div>
    <div class="setup-book-body">

      <!-- ═══ Tab: Book Setup ═══ -->
      <div class="setup-tab-content active" id="setup-tab-book">
        <div class="analysis-section">
          <h3>Book Details</h3>
          <div class="form-group">
            <label>Book Title</label>
            <input type="text" class="form-input" id="bs-title" placeholder="Your book title">
          </div>
          <div class="form-group">
            <label>Subtitle (optional)</label>
            <input type="text" class="form-input" id="bs-subtitle" placeholder="A subtitle for your book">
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">If set, the subtitle appears on the cover image below the title in smaller text.</p>
          </div>
        </div>

        <div class="analysis-section">
          <h3>Genre &amp; Voice</h3>
          <div class="setup-form-row">
            <div class="form-group">
              <label>Genre</label>
              <select class="form-input" id="bs-genre">
                <option value="">-- Select Genre --</option>
              </select>
            </div>
            <div class="form-group" id="bs-subgenre-group" style="display:none;">
              <label>Subgenre</label>
              <select class="form-input" id="bs-subgenre">
                <option value="">-- None (use main genre rules) --</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Narrative Voice / POV</label>
            <select class="form-input" id="bs-voice">
              <option value="auto">Auto (AI chooses based on context)</option>
              <option value="first-person">First Person (I/me/my)</option>
              <option value="third-limited">Third-Person Limited</option>
              <option value="third-omniscient">Third-Person Omniscient</option>
              <option value="third-objective">Third-Person Objective (camera eye)</option>
              <option value="deep-pov">Deep POV (close third-person)</option>
              <option value="second-person">Second Person (you/your)</option>
              <option value="unreliable">Unreliable Narrator</option>
              <option value="multiple-pov">Multiple POV (rotating perspectives)</option>
              <option value="stream-of-consciousness">Stream of Consciousness</option>
              <option value="epistolary">Epistolary (letters/documents/diary)</option>
            </select>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Controls the narrative perspective for all AI-generated prose in this project.</p>
          </div>
        </div>

        <div class="analysis-section">
          <h3>Book Size</h3>
          <div class="setup-form-row">
            <div class="form-group">
              <label>Total Word Count Goal</label>
              <input type="number" class="form-input" id="bs-total-words" value="80000" min="5000" step="1000" placeholder="80000">
            </div>
            <div class="form-group">
              <label>Number of Chapters</label>
              <input type="number" class="form-input" id="bs-num-chapters" value="20" min="1" max="200" placeholder="20">
            </div>
          </div>
          <div class="form-group" style="margin-top:4px;">
            <div class="stat-card" style="text-align:center;">
              <div class="stat-value" id="bs-words-per-chapter">4,000</div>
              <div class="stat-label">Approximate Words per Chapter</div>
            </div>
          </div>
        </div>

        <div class="analysis-section">
          <h3>Story Structure</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:10px;">
            Select a narrative structure template to guide your story's pacing and beat progression.
          </p>
          <div id="bs-structure-container"></div>
        </div>

        <div class="analysis-section">
          <h3>Front &amp; Back Matter</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Select pages to include before Chapter 1 and after the final chapter.
          </p>
          <div class="matter-columns" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
            <div>
              <h4 style="font-size:0.9rem;font-weight:600;color:var(--text-primary);margin-bottom:10px;">&#128214; Front Matter</h4>
              <div class="matter-grid" id="bs-front-matter-grid" style="display:flex;flex-direction:column;gap:6px;">
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-title-page" value="title-page" checked>
                  <div class="matter-info">
                    <span class="matter-name">Title Page</span>
                    <span class="matter-desc">Title, subtitle, and author name</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-copyright" value="copyright" checked>
                  <div class="matter-info">
                    <span class="matter-name">Copyright Page</span>
                    <span class="matter-desc">Copyright notice, ISBN, publisher info</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-dedication" value="dedication">
                  <div class="matter-info">
                    <span class="matter-name">Dedication</span>
                    <span class="matter-desc">Personal dedication page</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-epigraph" value="epigraph">
                  <div class="matter-info">
                    <span class="matter-name">Epigraph</span>
                    <span class="matter-desc">Opening quotation or excerpt</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-table-of-contents" value="table-of-contents" checked>
                  <div class="matter-info">
                    <span class="matter-name">Table of Contents</span>
                    <span class="matter-desc">Auto-generated from chapter titles</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-fm-prologue" value="prologue">
                  <div class="matter-info">
                    <span class="matter-name">Prologue</span>
                    <span class="matter-desc">Story preface or prologue chapter</span>
                  </div>
                </label>
              </div>
            </div>
            <div>
              <h4 style="font-size:0.9rem;font-weight:600;color:var(--text-primary);margin-bottom:10px;">&#128218; Back Matter</h4>
              <div class="matter-grid" id="bs-back-matter-grid" style="display:flex;flex-direction:column;gap:6px;">
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-epilogue" value="epilogue">
                  <div class="matter-info">
                    <span class="matter-name">Epilogue</span>
                    <span class="matter-desc">Story closing or aftermath</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-acknowledgments" value="acknowledgments">
                  <div class="matter-info">
                    <span class="matter-name">Acknowledgments</span>
                    <span class="matter-desc">Thank-you page for contributors</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-about-author" value="about-author" checked>
                  <div class="matter-info">
                    <span class="matter-name">About the Author</span>
                    <span class="matter-desc">Author bio and background</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-also-by" value="also-by">
                  <div class="matter-info">
                    <span class="matter-name">Also By This Author</span>
                    <span class="matter-desc">List of other published works</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-glossary" value="glossary">
                  <div class="matter-info">
                    <span class="matter-name">Glossary</span>
                    <span class="matter-desc">Terms and definitions</span>
                  </div>
                </label>
                <label class="matter-option">
                  <input type="checkbox" id="bs-bm-appendix" value="appendix">
                  <div class="matter-info">
                    <span class="matter-name">Appendix</span>
                    <span class="matter-desc">Supplementary material, maps, timelines</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <button class="btn btn-primary" id="btn-save-book-structure" style="width:100%;margin-top:12px;">Save Book Structure</button>
      </div>

      <!-- ═══ Tab: AI Writer ═══ -->
      <div class="setup-tab-content" id="setup-tab-ai-writer">
        <div class="analysis-section">
          <h3>Multi-Agent Writing</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Deploy multiple AI writing agents to generate competing drafts, then collaborate on selecting and improving the best one.
            A judge agent evaluates all candidates, and chapter agents check for continuity conflicts (GO/NO-GO).
          </p>
          <div class="setup-form-row">
            <div class="form-group">
              <label data-tooltip="Number of Writing Agents — How many parallel AI agents will generate competing prose drafts. More agents = more diversity but higher API cost. Each agent writes with a different creative 'temperature' for variety.">Writing Agents</label>
              <select class="form-input" id="bs-agent-count">
                <option value="1" selected>1 — Single agent (standard)</option>
                <option value="2">2 — Dual agent</option>
                <option value="3">3 — Triple agent (recommended)</option>
                <option value="4">4 — Quad agent</option>
                <option value="5">5 — Full squad</option>
              </select>
              <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">More agents = better selection but higher API usage. 1 = standard mode (no multi-agent).</p>
            </div>
            <div class="form-group">
              <label data-tooltip="Chapter Agents — When enabled, each chapter maintains a continuity agent that tracks every detail (characters, locations, timeline, plot points). Before new prose is accepted, all chapter agents are polled for conflicts — like NASA launch control GO/NO-GO.">Chapter Agents</label>
              <select class="form-input" id="bs-chapter-agents">
                <option value="enabled" selected>Enabled (GO/NO-GO checks)</option>
                <option value="disabled">Disabled</option>
              </select>
              <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Continuity guardians that check for conflicts across chapters before accepting new prose.</p>
            </div>
          </div>
        </div>

        <div class="analysis-section">
          <h3>AI Outline Generation</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Generate a detailed outline for each chapter based on your notes, characters, and book structure.
            The AI will analyze all your project information and create ~200-250 word outlines per chapter,
            auto-name each chapter, and populate the sidebar.
          </p>
          <div id="bs-outline-status" style="display:none;margin-bottom:12px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="generate-spinner"></div>
              <span id="bs-outline-status-text" style="font-size:0.85rem;color:#007AFF;">Generating outlines...</span>
            </div>
          </div>
          <div id="bs-outline-error" style="display:none;margin-bottom:12px;padding:12px;background:rgba(255,59,48,0.1);border-radius:var(--radius-sm);color:var(--danger);font-size:0.85rem;"></div>
          <button class="btn btn-primary" id="btn-generate-outlines" style="width:100%;">Generate Outlines</button>
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">
            This will create chapters with outlines. Existing chapters will not be affected. Make sure you have entered notes, characters, and book structure information first.
          </p>
        </div>

        <div class="analysis-section">
          <h3>Quality &amp; Style</h3>
          <div class="setup-form-row">
            <div class="form-group">
              <label data-tooltip="Quality Threshold -- Set the minimum quality score (out of 100) that AI-generated prose must achieve before the system moves to the next chunk.">Quality Threshold (%)</label>
              <input type="number" class="form-input" id="bs-quality-threshold" value="90" min="50" max="100" step="5" placeholder="90">
              <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Minimum score prose must reach before continuing. Lower = faster, higher = better quality.</p>
            </div>
            <div class="form-group">
              <label data-tooltip="Poetry Level -- Controls prose density and ornamentation. Level 1 is clean/invisible (Hemingway). Level 5 is lyrical/prose-poetry territory.">Poetry Level</label>
              <select class="form-input" id="bs-poetry-level">
                <option value="1">1 -- Clean, invisible (Hemingway)</option>
                <option value="2">2 -- Modest detail</option>
                <option value="3" selected>3 -- Literary (default)</option>
                <option value="4">4 -- Heightened, rich</option>
                <option value="5">5 -- Lyrical / prose-poetry</option>
              </select>
              <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">Controls prose density and ornamentation. Default: 3 (Literary).</p>
            </div>
          </div>
          <div class="form-group">
            <label data-tooltip="Author Palette -- Style influences for the AI to channel. List authors and their strengths, one per line.">Author Palette (style influences)</label>
            <textarea class="form-input" id="bs-author-palette" rows="3"
              placeholder="Morrison: elemental weight&#10;Tyler: domestic warmth&#10;Russo: working-class dignity&#10;Saunders: absurdist heart&#10;Strout: plainspoken power"></textarea>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">List authors and their strengths to channel, one per line. Leave blank for defaults.</p>
          </div>
        </div>

        <div class="analysis-section">
          <h3>AI Instructions</h3>
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">
            Persistent rules the AI must follow for every generation in this project. These are given high priority in the prompt.
          </p>
          <textarea class="form-input" id="generate-ai-instructions" rows="4" data-tooltip="Enter rules or constraints the AI must follow for every prose generation." placeholder="e.g. Each chapter covers exactly 10 years. Write in a formal, historical narrative style."></textarea>
          <button class="btn btn-primary" id="btn-save-ai-instructions" data-tooltip="Save these AI instructions to your project so they persist across sessions." style="width:100%;margin-top:6px;">Save Instructions</button>
        </div>

        <div class="analysis-section">
          <h3>Story Plot / Prompt</h3>
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:10px;">
            Describe what should happen in this scene. The more detail you provide, the better the output.
          </p>
          <textarea class="form-input" id="generate-plot" rows="6" data-tooltip="Describe what happens in this scene. Include character actions, dialogue hints, emotional beats, and setting details." placeholder="This field will be automatically populated when you generate chapters. You may modify the prompt here once chapter outlines are created."></textarea>
        </div>

        <div class="analysis-section">
          <h3>Options</h3>
          <div class="form-group">
            <label data-tooltip="Chunk Size Before Scoring — How many words the AI writes before stopping to score and improve the prose. Smaller chunks = more frequent quality checks but slower. Cannot exceed words per chapter. The full chapter is generated in chunks of this size.">Chunk Size Before Scoring</label>
            <select class="form-input" id="generate-word-target" data-tooltip="How many words to generate per chunk before scoring. Auto-calculated from your book structure.">
              <option value="250">~250 words per chunk</option>
              <option value="500" selected>~500 words per chunk</option>
              <option value="1000">~1,000 words per chunk</option>
            </select>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
              Words per chapter: <strong id="chunk-wpc-display">--</strong> &bull;
              Chunks needed: <strong id="chunk-count-display">--</strong>
            </p>
          </div>
          <div class="setup-form-row">
            <div class="form-group">
              <label>Tone (optional)</label>
              <input type="text" class="form-input" id="generate-tone" placeholder="e.g. dark, humorous, suspenseful, literary">
            </div>
            <div class="form-group">
              <label>Style Inspiration (optional)</label>
              <input type="text" class="form-input" id="generate-style" placeholder="e.g. Cormac McCarthy, Donna Tartt, Stephen King">
            </div>
          </div>
          <div class="form-group" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="generate-continue" checked style="width:20px;height:20px;">
            <label for="generate-continue" style="margin:0;">Continue from existing text in editor</label>
          </div>
          <div class="form-group" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="generate-use-characters" checked style="width:20px;height:20px;">
            <label for="generate-use-characters" style="margin:0;">Include character profiles as context</label>
          </div>
          <div class="form-group" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="generate-use-notes" checked style="width:20px;height:20px;">
            <label for="generate-use-notes" style="margin:0;">Include project notes as context</label>
          </div>
        </div>

        <div id="generate-status" style="display:none;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="generate-spinner"></div>
            <span id="generate-status-text" style="font-size:0.85rem;color:#007AFF;">Generating...</span>
          </div>
        </div>

        <div id="generate-error" style="display:none;margin-bottom:16px;padding:12px;background:rgba(255,59,48,0.1);border-radius:var(--radius-sm);color:var(--danger);font-size:0.85rem;"></div>

        <button class="btn" id="btn-generate-cancel" style="display:none;width:100%;">Stop</button>

        <div id="generate-no-key" style="display:none;margin-top:16px;padding:16px;background:var(--bg-secondary);border-radius:var(--radius-md);text-align:center;">
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            You need an Anthropic API key to generate prose.
          </p>
          <button class="btn btn-primary" id="btn-generate-open-settings">Open Settings to Add Key</button>
        </div>
      </div>

      <!-- ═══ Tab: Translation ═══ -->
      <div class="setup-tab-content" id="setup-tab-translation">
        <div class="analysis-section">
          <h3>&#127760; Translation</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Select languages for translation. When enabled, completed prose will be translated and saved as additional manuscript versions.
          </p>
          <div class="translation-grid" id="bs-translation-grid">
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-spanish" value="spanish">
              <span>Spanish</span>
            </label>
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-french" value="french">
              <span>French</span>
            </label>
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-italian" value="italian">
              <span>Italian</span>
            </label>
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-german" value="german">
              <span>German</span>
            </label>
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-portuguese" value="portuguese">
              <span>Portuguese</span>
            </label>
            <label class="translation-option">
              <input type="checkbox" id="bs-translate-japanese" value="japanese">
              <span>Japanese</span>
            </label>
          </div>
          <button class="btn" id="btn-perform-translation" style="width:100%;margin-top:12px;" disabled>
            Perform Translation
          </button>
          <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
            Select at least one language, then click to translate the current chapter's prose. Translation uses Claude AI and preserves narrative voice.
          </p>
        </div>
      </div>

      <!-- ═══ Tab: Export ═══ -->
      <div class="setup-tab-content" id="setup-tab-export">
        <div class="analysis-section">
          <h3>Export Formats</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;">
            Export your manuscript in various formats for submission, sharing, or backup.
          </p>

          <div class="setup-export-grid">
            <button class="btn" id="export-manuscript">
              Standard Manuscript Format (HTML)
              <br><span style="font-size:0.75rem;color:var(--text-muted);">Courier 12pt, double-spaced, Shunn format</span>
            </button>

            <button class="btn" id="export-html">
              Styled HTML
              <br><span style="font-size:0.75rem;color:var(--text-muted);">Beautiful reading format</span>
            </button>

            <button class="btn" id="export-plain">
              Plain Text
              <br><span style="font-size:0.75rem;color:var(--text-muted);">Universal .txt format</span>
            </button>

            <button class="btn" id="export-json">
              Full Backup (JSON)
              <br><span style="font-size:0.75rem;color:var(--text-muted);">Everything including chapters</span>
            </button>
          </div>
        </div>

        <div class="analysis-section">
          <h3>&#128196; DOCX Export</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Export chapters as a formatted DOCX file for Vellum import.
          </p>
          <button class="btn" id="btn-export-original-docx" style="width:100%;margin-bottom:8px;">
            &#128196; Export Original (English)
          </button>
          <div id="export-translation-buttons" style="display:flex;flex-direction:column;gap:6px;margin-top:8px;">
            <!-- Populated dynamically when translations exist -->
          </div>
        </div>

        <div class="analysis-section" id="export-cover-section" style="display:none;">
          <h3>Cover Image</h3>
          <img id="export-cover-preview" class="export-cover-preview" style="display:none;" alt="Cover preview">
          <button class="btn" id="export-cover-download" style="width:100%;margin-bottom:8px;">
            Download Cover Image (PNG)
            <br><span style="font-size:0.75rem;color:var(--text-muted);">High resolution book cover</span>
          </button>
        </div>

        <div class="analysis-section">
          <h3>Print</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
            Use your browser's print function (Cmd+P) for a clean manuscript printout.
          </p>
        </div>
      </div>

      <!-- ═══ Tab: Settings ═══ -->
      <div class="setup-tab-content" id="setup-tab-settings">
        <div id="panel-settings-body">
          <!-- Rendered dynamically by JS -->
        </div>
        <div style="margin-top:16px;">
          <button class="btn btn-sm" id="btn-error-database-popup" data-tooltip="View and manage the cross-project error pattern database." style="width:100%;margin-bottom:8px;">
            &#9888; Error Pattern Database
          </button>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- ===== Prose Review Modal ===== -->
<div class="modal-overlay" id="prose-review-overlay">
  <div class="modal" style="width:min(600px, 90vw);max-height:90vh;">
    <div class="modal-header">
      <h2>Prose Quality Review</h2>
    </div>
    <div class="modal-body" id="prose-review-body" style="overflow-y:auto;">
      <!-- Rendered dynamically -->
    </div>
    <div class="modal-footer" style="flex-wrap:wrap;gap:8px;">
      <div style="display:flex;gap:4px;width:100%;margin-bottom:4px;">
        <button class="btn btn-primary continue-word-btn" data-words="250" style="flex:1;font-size:0.8rem;">+250</button>
        <button class="btn btn-primary continue-word-btn" data-words="500" style="flex:1;font-size:0.8rem;">+500</button>
        <button class="btn btn-primary continue-word-btn" data-words="1000" style="flex:1;font-size:0.8rem;">+1,000</button>
        <button class="btn btn-primary continue-word-btn" data-words="2000" style="flex:1;font-size:0.8rem;">+2,000</button>
        <button class="btn" id="btn-prose-review-rethink" style="font-size:0.8rem;">Rethink</button>
      </div>
      <div style="display:flex;gap:8px;width:100%;">
        <button class="btn" id="btn-prose-review-accept" style="flex:1;">Accept Prose</button>
        <button class="btn btn-danger-outline" id="btn-prose-review-rewrite-serious" style="flex:1;">Fix Serious Only</button>
        <button class="btn btn-primary" id="btn-prose-review-rewrite" style="flex:1;">Fix All Issues</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Scoring Progress Overlay ===== -->
<div class="modal-overlay" id="scoring-progress-overlay">
  <div class="modal" style="width:min(360px, 85vw);">
    <div class="modal-body" style="padding:32px 24px;text-align:center;">
      <div style="font-size:0.95rem;font-weight:600;color:var(--text-primary);margin-bottom:16px;">Scoring in progress</div>
      <div class="scoring-progress-bar">
        <div class="scoring-progress-fill"></div>
      </div>
      <p style="font-size:0.8rem;color:var(--text-muted);margin-top:12px;">Analyzing prose quality&hellip;</p>
    </div>
  </div>
</div>

<!-- ===== Iterative Writing Progress Overlay ===== -->
<div class="modal-overlay" id="iterative-write-overlay">
  <div class="modal" style="width:min(440px, 90vw);">
    <div class="modal-body" style="padding:28px 24px;text-align:center;">
      <div style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Iterative Writing</div>
      <div id="iterative-chunk-label" class="iterative-chunk-info">Chunk <span id="iterative-chunk-num">1</span></div>
      <div id="iterative-phase-label" style="font-size:0.85rem;font-weight:600;color:var(--accent-primary);margin-bottom:12px;">Generating paragraph&hellip;</div>

      <!-- Prominent scoring notice -->
      <div id="iterative-scoring-notice" class="iterative-scoring-notice">
        <div class="scoring-dot"></div>
        <div class="scoring-label">Scoring</div>
        <div class="scoring-dot"></div>
      </div>

      <div class="iterative-score-display">
        <div id="iterative-score-value" class="iterative-score-number">--</div>
        <div id="iterative-score-label" style="font-size:0.75rem;color:var(--text-muted);">Score / 100</div>
      </div>

      <div style="margin:16px 0;">
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;">
          <span>Quality Score</span>
          <span id="iterative-score-pct">0%</span>
        </div>
        <div class="iterative-progress-bar">
          <div id="iterative-progress-fill" class="iterative-progress-fill" style="width:0%;"></div>
          <div id="iterative-progress-threshold" class="iterative-progress-threshold"></div>
        </div>
        <div style="display:flex;justify-content:flex-end;font-size:0.7rem;color:var(--text-muted);margin-top:2px;">
          <span id="iterative-threshold-label">Target: 90%</span>
        </div>
      </div>

      <div id="iterative-iteration-info" style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;">
        Iteration: <span id="iterative-iteration-num">0</span> &bull; Best: <span id="iterative-best-score">--</span>
      </div>
      <div id="iterative-score-history" style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;text-align:left;padding:4px 8px;display:none;">
      </div>

      <div id="iterative-four-reqs" style="display:none;margin-bottom:8px;text-align:left;font-size:0.75rem;padding:6px 8px;background:var(--bg-secondary);border-radius:var(--radius-sm);">
        <div style="font-weight:600;color:var(--text-secondary);margin-bottom:4px;">Four Requirements</div>
        <div id="four-req-thought" style="color:var(--text-muted);">&#x25CB; Character-specific thought</div>
        <div id="four-req-observation" style="color:var(--text-muted);">&#x25CB; Precise observation</div>
        <div id="four-req-musical" style="color:var(--text-muted);">&#x25CB; Musical sentence</div>
        <div id="four-req-break" style="color:var(--text-muted);">&#x25CB; Expectation break</div>
      </div>

      <!-- Agent Status Panel (shown during multi-agent mode) -->
      <div id="iterative-agent-panel" style="display:none;margin-bottom:12px;">
        <div style="font-size:0.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-align:left;">AGENTS</div>
        <div id="iterative-agent-grid" class="ma-agent-grid" style="margin-bottom:8px;"></div>
        <div style="margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:var(--text-muted);margin-bottom:4px;">
            <span>Generate</span>
            <span>Judge</span>
            <span>Fix</span>
            <span>Edit</span>
            <span>GO/NO-GO</span>
          </div>
          <div class="ma-pipeline-bar">
            <div id="iterative-pipeline-fill" class="ma-pipeline-fill" style="width:0%;"></div>
          </div>
        </div>
        <div id="iterative-agent-log" class="ma-status-log" style="max-height:60px;font-size:0.7rem;"></div>
      </div>

      <div id="iterative-status-log" style="font-size:0.75rem;color:var(--text-muted);max-height:80px;overflow-y:auto;text-align:left;padding:8px;background:var(--bg-secondary);border-radius:var(--radius-sm);margin-bottom:16px;">
        Starting iterative writing&hellip;
      </div>

      <button class="btn btn-sm" id="btn-iterative-cancel" style="min-width:100px;">Cancel</button>
    </div>
  </div>
</div>

<!-- ===== Multi-Agent Progress Overlay ===== -->
<div class="modal-overlay" id="multi-agent-overlay" style="display:none;">
  <div class="modal" style="width:min(520px, 92vw);">
    <div class="modal-body" style="padding:28px 24px;text-align:center;">
      <div style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Multi-Agent Pipeline</div>
      <div id="ma-phase-label" style="font-size:0.85rem;font-weight:600;color:var(--accent-primary);margin-bottom:16px;">Deploying writing agents&hellip;</div>

      <!-- Agent Status Grid -->
      <div id="ma-agent-grid" class="ma-agent-grid">
        <!-- Populated dynamically -->
      </div>

      <!-- Pipeline Progress -->
      <div style="margin:16px 0 8px;">
        <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--text-muted);margin-bottom:6px;">
          <span>Generate</span>
          <span>Judge</span>
          <span>Fix</span>
          <span>Edit</span>
          <span>GO/NO-GO</span>
        </div>
        <div class="ma-pipeline-bar">
          <div id="ma-pipeline-fill" class="ma-pipeline-fill" style="width:0%;"></div>
        </div>
      </div>

      <!-- Status Log -->
      <div id="ma-status-log" class="ma-status-log">
        Initializing multi-agent pipeline&hellip;
      </div>

      <button class="btn btn-sm" id="btn-ma-cancel" style="min-width:100px;margin-top:12px;">Cancel</button>
    </div>
  </div>
</div>

<!-- ===== GO/NO-GO Mission Control Overlay ===== -->
<div class="modal-overlay" id="go-nogo-overlay" style="display:none;">
  <div class="modal" style="width:min(560px, 92vw);">
    <div class="modal-body" style="padding:0;">
      <div class="go-nogo-header">
        <div class="go-nogo-title">MISSION CONTROL</div>
        <div class="go-nogo-subtitle">GO / NO-GO Check</div>
      </div>

      <div style="padding:20px 24px;">
        <!-- Chapter Agent Results -->
        <div id="go-nogo-results" class="go-nogo-results">
          <!-- Populated dynamically -->
        </div>

        <!-- Overall Status -->
        <div id="go-nogo-status" class="go-nogo-overall">
          <div id="go-nogo-status-icon" class="go-nogo-status-icon">&#x2714;</div>
          <div id="go-nogo-status-text" class="go-nogo-status-text">ALL SYSTEMS GO</div>
        </div>

        <!-- Conflict Details (shown when NO-GO) -->
        <div id="go-nogo-conflicts" style="display:none;margin-top:16px;">
          <h4 style="font-size:0.85rem;color:var(--danger);margin-bottom:8px;">Conflicts Detected</h4>
          <div id="go-nogo-conflict-list" class="go-nogo-conflict-list">
            <!-- Populated dynamically -->
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:20px;justify-content:center;">
          <button class="btn btn-primary" id="btn-go-nogo-accept" style="min-width:140px;">Accept Prose</button>
          <button class="btn" id="btn-go-nogo-reject" style="min-width:140px;display:none;">Reject &amp; Regenerate</button>
          <button class="btn" id="btn-go-nogo-override" style="min-width:140px;display:none;">Override NO-GO</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Iterative Writing Accept Overlay ===== -->
<div class="modal-overlay" id="iterative-accept-overlay">
  <div class="modal" style="width:min(480px, 90vw);">
    <div class="modal-header">
      <h2>Paragraph Ready</h2>
    </div>
    <div class="modal-body">
      <div class="iterative-score-display" style="margin-bottom:12px;">
        <div id="iterative-accept-score" class="iterative-score-number score-excellent">--</div>
        <div style="font-size:0.8rem;color:var(--text-muted);">Quality Score Achieved</div>
      </div>
      <div id="iterative-accept-preview" style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-sm);max-height:200px;overflow-y:auto;margin-bottom:12px;"></div>
      <p style="font-size:0.8rem;color:var(--text-muted);text-align:center;">
        Accept this paragraph and continue to the next, or reject to keep refining.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-iterative-reject">Keep Refining</button>
      <button class="btn btn-primary" id="btn-iterative-accept">Accept &amp; Continue</button>
      <button class="btn" id="btn-iterative-accept-stop">Accept &amp; Stop</button>
    </div>
  </div>
</div>

<!-- ===== Rethink Modal ===== -->
<div class="modal-overlay" id="rethink-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Rethink Chapter Outline</h2>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Provide instructions for how the chapter outline should be revised. The AI will rewrite the outline based on your guidance.
      </p>
      <textarea class="form-input" id="rethink-prompt" rows="4" placeholder='e.g. "Enhance character X\'s role in this chapter" or "Do not discuss X, Y, or Z"'></textarea>
      <div id="rethink-status" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span style="font-size:0.85rem;color:var(--accent-primary);">Rethinking outline...</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-rethink-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-rethink-submit">Rethink</button>
    </div>
  </div>
</div>

<!-- ===== Outline Review Popup (overlays Setup Book) ===== -->
<div class="outline-review-overlay" id="outline-review-overlay">
  <div class="outline-review-modal">
    <div class="outline-review-header">
      <h2>Review Generated Outlines</h2>
      <button class="panel-close" id="btn-close-outline-review" aria-label="Close">&times;</button>
    </div>
    <div class="outline-review-body" id="outline-review-body">
      <!-- Populated dynamically with chapter outlines -->
    </div>
    <div class="outline-review-footer">
      <button class="btn" id="btn-outline-rethink" style="background:#dc3545;color:#fff;border-color:#dc3545;">Rethink Outline</button>
      <button class="btn btn-primary" id="btn-outline-accept">Accept Outline</button>
    </div>
  </div>
</div>

<!-- ===== Rethink Comments Popup (overlays Outline Review) ===== -->
<div class="rethink-comments-overlay" id="rethink-comments-overlay">
  <div class="rethink-comments-modal">
    <div class="modal-header" style="padding:20px 24px;border-bottom:1px solid var(--border-color);background:var(--bg-secondary);">
      <h2 style="font-size:1.2rem;font-weight:700;">Rethink Outline</h2>
    </div>
    <div class="modal-body" style="padding:24px;">
      <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:14px;line-height:1.5;">
        Describe the changes you want applied to the outline. The AI will revise all chapter outlines based on your instructions.
      </p>
      <textarea class="form-input" id="rethink-comments-prompt" rows="5" placeholder='e.g. "Delete all references to character X" or "Make the conflict more intense in chapters 5-10" or "Add a subplot involving..."'></textarea>
      <div id="rethink-comments-status" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span style="font-size:0.85rem;color:#007AFF;">Rethinking outlines...</span>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="padding:16px 24px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:10px;">
      <button class="btn" id="btn-rethink-comments-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-rethink-comments-submit">Rethink &amp; Regenerate</button>
    </div>
  </div>
</div>

<!-- ===== New Project Help Modal ===== -->
<div class="modal-overlay" id="new-project-help-overlay">
  <div class="modal new-project-help-modal">
    <div class="modal-header">
      <h2>Welcome to Genesis 2</h2>
    </div>
    <div class="modal-body" style="overflow-y:auto;">
      <p style="font-size:0.95rem;color:var(--text-secondary);margin-bottom:20px;line-height:1.7;">
        Genesis 2 is a complete writing studio designed to help you craft world-class, publication-ready prose from concept to finished manuscript. Here's how to get started with your new project:
      </p>

      <div class="help-step">
        <div class="help-step-number">1</div>
        <div class="help-step-content">
          <h3>Set Up Your Book Structure</h3>
          <p>Start by tapping the <strong>Setup Book</strong> button in the sidebar. Here you'll define your book's total word count goal, number of chapters, and <strong>quality threshold</strong> (the minimum score AI-generated prose must achieve before moving to the next section). Genesis calculates approximate words per chapter to help plan pacing. Choose a narrative structure template (Three-Act, Hero's Journey, Seven-Point, Kishoutenketsu) to guide your story.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">2</div>
        <div class="help-step-content">
          <h3>Create Your Characters</h3>
          <p>Switch to the <strong>Characters</strong> tab to build detailed character profiles. Add names, roles, descriptions, motivations, and character arcs. These profiles are automatically fed to the AI when generating prose, ensuring your characters stay consistent throughout the story.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">3</div>
        <div class="help-step-content">
          <h3>Add Notes &amp; Research</h3>
          <p>Use the <strong>Notes</strong> tab to organize your story's foundation. Create notes for:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li><strong>Story Plot</strong> -- Outline major plot points, twists, and the arc of your narrative</li>
            <li><strong>World Building</strong> -- Detail settings, rules, history, and the world your characters inhabit</li>
            <li><strong>General Notes</strong> -- Keep track of themes, tone, timelines, and style preferences</li>
            <li><strong>Research</strong> -- Store reference material, historical facts, and technical details for accuracy</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">4</div>
        <div class="help-step-content">
          <h3>Configure Project Settings</h3>
          <p>Tap the <strong>gear icon</strong> (&#9881;) in the toolbar to access Settings. Under Project Settings you can:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li>Set your book's <strong>title</strong> and <strong>subtitle</strong></li>
            <li>Choose a <strong>genre</strong> and <strong>sub-genre</strong> to guide the AI's writing style</li>
            <li>Select a <strong>narrative voice/POV</strong> (first-person, third-limited, deep POV, and more)</li>
            <li>View and change your <strong>story structure</strong> template and track pacing progress</li>
            <li>Add a persistent <strong>AI prompt</strong> that carries across all chapters for rules like tense or stylistic constraints</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">5</div>
        <div class="help-step-content">
          <h3>Generate Chapter Outlines</h3>
          <p>Once your structure, characters, and notes are in place, open <strong>Setup Book</strong> and use <strong>Generate Outlines</strong>. The AI will analyze everything you've entered and create detailed outlines for each chapter, giving you a roadmap for your entire book.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">6</div>
        <div class="help-step-content">
          <h3>Write &amp; Generate Prose</h3>
          <p>Select any chapter from the sidebar and start writing. Use the <strong>AI</strong> button in the toolbar to generate prose. Prose is generated in scored chunks, with each chunk automatically scored and rewritten if it falls below your quality threshold. You can also use <strong>Iterative Write</strong> to generate one paragraph at a time with fine-grained quality control. Generated chapters automatically begin with an <strong>H1 heading</strong> (for KDP table of contents) and include <strong>scene breaks</strong> between beats and at chapter endings. Continue writing with the +1,000, +2,000, or +3,000 word buttons.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">7</div>
        <div class="help-step-content">
          <h3>Analyze &amp; Refine</h3>
          <p>Use the <strong>anvil icon</strong> (&#9874;) in the toolbar for prose analysis to check quality, pacing, and style. The AI scores your prose across 8 dimensions and highlights areas for improvement. Use <strong>Fix Serious Only</strong> or <strong>Fix All Issues</strong> for automated rewriting. The <strong>Rethink</strong> tool lets you revise chapter outlines.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">8</div>
        <div class="help-step-content">
          <h3>Generate a Book Cover</h3>
          <p>Once you have prose written, the sidebar displays a cover area. Tap <strong>Create Cover</strong> to generate an AI-powered book cover image based on your story's content and genre. You can regenerate it as many times as you like until you're satisfied. A Hugging Face API token is required (free tier available) -- add it in Settings.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">9</div>
        <div class="help-step-content">
          <h3>Export Your Manuscript</h3>
          <p>When you're ready, tap the <strong>export icon</strong> (&#8681;) to export in multiple formats: Standard Manuscript (Shunn format with H1 chapter headings for KDP table of contents), Styled HTML, Plain Text, or a full JSON backup. Scene breaks are properly formatted in all export formats. You can also download your cover image separately.</p>
        </div>
      </div>

      <div style="background:var(--bg-secondary);border-radius:var(--radius-md);padding:16px;margin-top:20px;">
        <h3 style="font-size:0.85rem;font-weight:600;color:var(--accent-primary);margin-bottom:8px;">Tips for Best Results</h3>
        <ul style="margin:0 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.8;">
          <li>The more detail you put into characters, notes, and outlines, the better the AI prose will be</li>
          <li>Use the AI Instructions field (in the AI panel) for persistent rules the AI must follow in every generation</li>
          <li><strong>Em dashes are banned</strong> from all AI-generated prose (they signal AI writing and format poorly in published works)</li>
          <li>Lower your <strong>quality threshold</strong> (in Setup Book) for faster generation, raise it for higher quality</li>
          <li>Use the chapter toolbar's <strong>Select All</strong> and <strong>Delete Selected</strong> to manage chapters in bulk</li>
          <li>Set a daily writing goal in Settings to track your progress and build a consistent habit</li>
          <li>Tap the <strong>?</strong> button in the toolbar anytime for a complete features guide</li>
          <li>Use Focus Mode (&#9673;) to remove all distractions when you need to concentrate</li>
          <li>Your work is saved automatically to both local storage and the cloud</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-primary" id="btn-help-create-project" style="padding:14px 48px;font-size:1rem;">Create Project Now</button>
    </div>
  </div>
</div>

<!-- ===== New Project Creation Modal ===== -->
<div class="modal-overlay" id="new-project-overlay">
  <div class="modal" style="width:min(520px, 90vw);max-height:90vh;">
    <div class="modal-header">
      <h2>Create New Project</h2>
    </div>
    <div class="modal-body" style="overflow-y:auto;">
      <div class="form-group">
        <label>Project Title</label>
        <input type="text" class="form-input" id="new-project-title" placeholder="My Novel" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Genre</label>
        <select class="form-input" id="new-project-genre">
          <option value="">— Select Genre (optional) —</option>
        </select>
      </div>
      <div class="form-group" id="new-project-subgenre-group" style="display:none;">
        <label>Subgenre</label>
        <select class="form-input" id="new-project-subgenre">
          <option value="">— None —</option>
        </select>
      </div>
      <div class="form-group">
        <label>Word Count Goal</label>
        <input type="number" class="form-input" id="new-project-word-goal" value="80000" min="1000" step="1000">
      </div>
      <div class="form-group">
        <label>Story Structure</label>
        <select class="form-input" id="new-project-structure">
          <!-- Populated dynamically -->
        </select>
        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
          Choose a narrative structure template to guide your story's pacing. Select "User / AI Created Outline" if you prefer to define your own chapter-by-chapter outline.
        </p>
      </div>

      <div style="margin-top:16px;padding:14px;background:var(--bg-secondary);border-radius:var(--radius-md);border-left:3px solid var(--accent-primary);">
        <p style="font-size:0.9rem;font-weight:600;color:var(--text-primary);margin-bottom:8px;">Before You Start Writing</p>
        <p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6;">
          After creating your project, fill out the AI section for best results:
        </p>
        <ul style="font-size:0.85rem;color:var(--text-secondary);line-height:1.8;margin:8px 0 0 16px;">
          <li><strong>Characters</strong> — Add profiles with names, roles, and descriptions</li>
          <li><strong>Notes</strong> — Add world-building details, plot notes, and research</li>
          <li><strong>AI Instructions</strong> — Set persistent rules for prose generation (in the AI panel)</li>
          <li><strong>Genre &amp; Style</strong> — Configure in Settings for genre-specific prose rules</li>
        </ul>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-top:8px;">
          The more context you provide, the better the AI-generated prose will be.
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-new-project-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-new-project-accept">Accept &amp; Continue</button>
    </div>
  </div>
</div>

<!-- ===== Accept Chapter Outline Confirmation Modal ===== -->
<div class="modal-overlay" id="accept-outline-overlay">
  <div class="modal" style="width:min(900px, 95vw);max-height:90vh;">
    <div class="modal-header">
      <h2>Before You Generate</h2>
    </div>
    <div class="accept-outline-columns">
      <!-- Left column: checklist -->
      <div class="accept-outline-left">
        <p style="font-size:0.9rem;color:var(--text-secondary);line-height:1.5;">
          Please confirm you have completed the following:
        </p>
        <p style="font-size:0.85rem;font-weight:600;color:var(--text-primary);margin:14px 0 4px 0;">AI Fields</p>
        <ul style="font-size:0.85rem;color:var(--text-secondary);line-height:1.8;margin:0 0 0 16px;">
          <li>Characters and their profiles</li>
          <li>Project notes and world-building details</li>
          <li>AI instructions and writing preferences</li>
          <li>Genre and style settings</li>
        </ul>
        <p style="font-size:0.85rem;font-weight:600;color:var(--text-primary);margin:14px 0 4px 0;">Book Setup</p>
        <ul style="font-size:0.85rem;color:var(--text-secondary);line-height:1.8;margin:0 0 0 16px;">
          <li>Book title and word count goal</li>
          <li>Story structure template</li>
          <li>Voice and point of view</li>
        </ul>
      </div>
      <!-- Right column: chapter outline(s) -->
      <div class="accept-outline-right">
        <h3 id="accept-outline-ch-title" style="font-family:var(--font-serif);font-size:1.05rem;color:var(--accent-primary);margin-bottom:10px;">Chapter Outline</h3>
        <!-- Single chapter outline (original) -->
        <div id="accept-outline-single">
          <textarea class="accept-outline-textarea" id="accept-outline-text" rows="10"
            placeholder="No outline available for this chapter."></textarea>
        </div>
        <!-- Multi-chapter outlines container -->
        <div id="accept-outline-multi" style="display:none;max-height:45vh;overflow-y:auto;"></div>
        <div class="accept-outline-btn-row">
          <button class="btn btn-primary" id="btn-accept-outline-accept">Accept Outline</button>
          <button class="btn" id="btn-accept-outline-rethink" style="background:#dc3545;color:#fff;border-color:#dc3545;">Rethink</button>
        </div>
        <div class="accept-outline-rethink-area" id="accept-outline-rethink-area" style="display:none;">
          <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:8px;">
            Describe what to add, remove, or change:
          </p>
          <textarea class="form-input" id="accept-outline-rethink-prompt" rows="3"
            placeholder='e.g. "Add more conflict" or "Remove the subplot about..." or "Make the ending darker"'></textarea>
          <div id="accept-outline-rethink-status" style="display:none;margin-top:10px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div class="generate-spinner"></div>
              <span style="font-size:0.85rem;color:var(--accent-primary);">Rethinking outline...</span>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn btn-primary" id="btn-accept-outline-rethink-submit">Finished</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-accept-outline-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-accept-outline-continue">Continue</button>
    </div>
  </div>
</div>

<!-- ===== Prose Rethink Modal ===== -->
<div class="modal-overlay" id="prose-rethink-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2>Rethink Prose</h2>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:12px;">
        Describe how the prose should be revised. The AI will rewrite the prose based on your instructions while keeping the same story events and characters.
      </p>
      <textarea class="form-input" id="prose-rethink-prompt" rows="4" placeholder='e.g. "Make the dialogue more natural" or "Add more sensory detail to the opening scene" or "Reduce the purple prose"'></textarea>
      <div id="prose-rethink-status" style="display:none;margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="generate-spinner"></div>
          <span style="font-size:0.85rem;color:var(--accent-primary);">Rewriting prose...</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btn-prose-rethink-cancel">Cancel</button>
      <button class="btn btn-primary" id="btn-prose-rethink-submit">Rewrite</button>
    </div>
  </div>
</div>

<!-- ===== Import Knowledge Panel ===== -->
<div class="panel" id="panel-import-knowledge">
  <div class="panel-header">
    <h2>Import Knowledge</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-import-knowledge-body">
    <p style="color:var(--text-secondary); margin-bottom:16px;">
      Import external research and reference materials into this project. These knowledge bases will be consulted during prose creation as reference materials.
    </p>
    <div class="form-group" style="margin-bottom:12px;">
      <label for="knowledge-title">Knowledge Title</label>
      <input type="text" id="knowledge-title" class="form-input" placeholder="e.g., Henry Ford Research Report">
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label for="knowledge-type">Type</label>
      <select id="knowledge-type" class="form-input">
        <option value="research">AI Research Report</option>
        <option value="reference">Reference Article</option>
        <option value="wikipedia">Wikipedia Content</option>
        <option value="notes">General Notes</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:12px;">
      <label>Import Method</label>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn btn-sm" id="btn-knowledge-paste" style="flex:1;">Paste Text</button>
        <button class="btn btn-sm" id="btn-knowledge-file" style="flex:1;">Upload File</button>
      </div>
      <input type="file" id="knowledge-file-input" accept=".txt,.md,.html,.json,.doc,.rtf" style="display:none;">
    </div>
    <div class="form-group" id="knowledge-paste-area" style="margin-bottom:12px; display:none;">
      <label for="knowledge-content">Content</label>
      <textarea id="knowledge-content" class="form-input" rows="12" placeholder="Paste your research content here..."></textarea>
    </div>
    <div id="knowledge-file-info" style="display:none; margin-bottom:12px; padding:8px; background:var(--bg-secondary); border-radius:var(--radius-sm); color:var(--text-secondary); font-size:13px;">
    </div>
    <button class="btn btn-primary" id="btn-knowledge-save" style="width:100%; margin-bottom:16px;">Save Knowledge to Project</button>
    <hr style="border-color:var(--border-color); margin:16px 0;">
    <h3 style="margin-bottom:12px;">Project Knowledge Base</h3>
    <div id="knowledge-list" style="max-height:300px; overflow-y:auto;">
      <p style="color:var(--text-muted); font-size:13px;">No knowledge imported yet.</p>
    </div>
  </div>
</div>

<!-- ===== Full-Screen Cover Editor ===== -->
<div id="cover-editor-overlay" class="cover-editor-overlay">
  <div class="cover-editor-header">
    <h2>Cover Editor</h2>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn btn-primary btn-sm" id="btn-ce-save">Save Cover</button>
      <button class="panel-close" id="btn-ce-close" aria-label="Close">&times;</button>
    </div>
  </div>
  <div class="cover-editor-body">
    <!-- Canvas Preview Area -->
    <div class="cover-editor-canvas-area">
      <div class="cover-editor-canvas-wrapper">
        <canvas id="cover-edit-canvas"></canvas>
      </div>
      <div id="ce-canvas-info" class="ce-canvas-info"></div>
    </div>
    <!-- Controls Sidebar -->
    <div class="cover-editor-controls" id="ce-controls">
      <!-- Image Dimensions -->
      <div class="ce-section">
        <div class="ce-section-title" data-section="dims">Image Dimensions</div>
        <div class="ce-section-body">
          <div class="ce-row">
            <div class="form-group ce-half">
              <label>Width</label>
              <input type="number" id="ce-width" class="form-input" value="6" step="0.01" min="0.1">
            </div>
            <div class="form-group ce-half">
              <label>Height</label>
              <input type="number" id="ce-height" class="form-input" value="9" step="0.01" min="0.1">
            </div>
          </div>
          <div class="ce-row">
            <div class="form-group ce-half">
              <label>Unit</label>
              <select id="ce-unit" class="form-input">
                <option value="in" selected>Inches</option>
                <option value="cm">Centimeters</option>
                <option value="px">Pixels</option>
              </select>
            </div>
            <div class="form-group ce-half">
              <label>DPI (72–300)</label>
              <input type="number" id="ce-dpi" class="form-input" value="300" min="72" max="300">
            </div>
          </div>
          <label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer;font-size:0.85rem;">
            <input type="checkbox" id="ce-lock-aspect" style="width:18px;height:18px;">
            Constrain proportions
          </label>
          <button class="btn btn-sm" id="btn-ce-apply-dims" style="width:100%;">Apply Dimensions</button>
        </div>
      </div>
      <!-- Image Generation -->
      <div class="ce-section">
        <div class="ce-section-title" data-section="gen">Image Generation</div>
        <div class="ce-section-body">
          <div class="form-group">
            <label>Prompt</label>
            <textarea id="ce-prompt" class="form-input" rows="3" placeholder="Describe the cover image you want generated..."></textarea>
          </div>
          <div class="form-group">
            <label>Reference Image</label>
            <input type="file" id="ce-ref-input" accept="image/*" style="display:none;">
            <div style="display:flex;gap:6px;">
              <button class="btn btn-sm" id="btn-ce-ref-upload" style="flex:1;">Upload Reference</button>
              <button class="btn btn-sm" id="btn-ce-ref-use-bg" style="flex:1;" title="Use the reference image as the cover background">Use as Background</button>
            </div>
            <div id="ce-ref-preview" style="display:none;text-align:center;margin-top:6px;">
              <img id="ce-ref-thumb" style="max-width:100%;max-height:80px;border-radius:4px;">
              <br><button class="btn btn-sm" id="btn-ce-ref-remove" style="font-size:0.75rem;margin-top:4px;">Remove</button>
            </div>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-sm" id="btn-ce-auto-prompt" style="flex:1;" title="Generate a prompt from your story using AI">Auto-Prompt</button>
            <button class="btn btn-primary btn-sm" id="btn-ce-generate" style="flex:1;">Generate Image</button>
          </div>
          <div id="ce-gen-status" style="display:none;margin-top:8px;font-size:0.8rem;color:var(--accent-primary);text-align:center;"></div>
        </div>
      </div>
      <!-- Text Blocks -->
      <div class="ce-section">
        <div class="ce-section-title" data-section="text">Text Blocks</div>
        <div class="ce-section-body" style="padding:8px;">
          <p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 8px;">Click text on canvas to select. Drag to move.</p>
          <div id="ce-blocks-list"></div>
          <button class="btn btn-sm" id="btn-ce-add-block" style="width:100%;margin-top:6px;">+ Add Text Block</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Pattern Database Panel (kept for popup access) -->
<div class="panel" id="panel-error-database">
  <div class="panel-header">
    <h2>Error Pattern Database</h2>
    <button class="panel-close" aria-label="Close">&times;</button>
  </div>
  <div class="panel-body" id="panel-error-database-body">
    <!-- Rendered dynamically by app.js -->
  </div>
</div>

<!-- ===== Help / Features Guide Modal ===== -->
<div class="modal-overlay" id="help-features-overlay">
  <div class="modal new-project-help-modal" style="max-width:640px;">
    <div class="modal-header">
      <h2>Genesis 2 Features Guide</h2>
    </div>
    <div class="modal-body" style="overflow-y:auto;max-height:70vh;">

      <div class="help-step">
        <div class="help-step-number">&#9998;</div>
        <div class="help-step-content">
          <h3>Rich Text Editor</h3>
          <p>A full-featured prose editor with <strong>bold</strong>, <strong>italic</strong>, <strong>heading</strong>, <strong>blockquote</strong>, and <strong>scene break</strong> formatting. Undo/redo support, auto-save to cloud and local storage, and real-time word count tracking. Focus Mode hides all UI for distraction-free writing.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">AI</div>
        <div class="help-step-content">
          <h3>AI Prose Generator</h3>
          <p>Generate prose from scene descriptions using Claude AI. Choose word targets from 250 to 2,000 words. Set tone, style inspiration, and use your characters and notes as context. AI Instructions persist across sessions and apply to every generation. The AI avoids common AI writing patterns, PET phrases, and em dashes to produce authentic, human-sounding prose.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#9881;</div>
        <div class="help-step-content">
          <h3>Iterative Writing</h3>
          <p>Generate prose in ~100-word chunks with automatic quality scoring and refinement. Each chunk is scored against 8 dimensions (sentence variety, dialogue, sensory detail, emotional resonance, vocabulary, narrative flow, originality, and technical execution). If a chunk scores below your quality threshold, it is automatically rewritten and rescored until it passes or max iterations are reached. You approve each paragraph before continuing.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#9874;</div>
        <div class="help-step-content">
          <h3>Scored Chunk Generation</h3>
          <p>Standard prose generation (1,000+ words) uses scored chunks. The total word target is broken into ~1,000-word segments. Each segment is generated, scored, and if it falls below your quality threshold, automatically rewritten and rescored before the next segment begins. This ensures consistent quality across longer passages.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#9888;</div>
        <div class="help-step-content">
          <h3>Error Pattern Database</h3>
          <p>Tracks common prose errors (PET phrases, AI patterns, weak words, cliches, etc.) found during scoring across all projects. These patterns are automatically used as "negative prompts" during future prose generation, teaching the AI to avoid repeating the same mistakes. View and manage patterns via the <strong>&#9888;</strong> toolbar button. Patterns seen 2+ times become active negative prompts.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">%</div>
        <div class="help-step-content">
          <h3>Variable Quality Threshold</h3>
          <p>Set the minimum quality score (50-100%) in <strong>Setup Book &gt; Quality Settings</strong>. Lower thresholds generate faster with fewer rewrites. Higher thresholds produce more polished prose but require more API calls. Default is 90%. The threshold applies to both iterative writing and scored chunk generation.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#9878;</div>
        <div class="help-step-content">
          <h3>Prose Analysis &amp; Rewriting</h3>
          <p>Analyze any chapter for quality using the <strong>anvil icon</strong>. Claude scores your prose across 8 dimensions and identifies specific issues with severity levels and estimated point impact. Use <strong>Fix Serious Only</strong> to address high-impact issues, or <strong>Fix All Issues</strong> for comprehensive improvement. The rewrite engine makes surgical changes while preserving your voice.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#9733;</div>
        <div class="help-step-content">
          <h3>Chapter Headings &amp; Scene Breaks</h3>
          <p>Generated chapters automatically begin with a <strong>Heading 1</strong> chapter title for KDP table of contents compatibility. Scene breaks (<strong>* * *</strong>) are automatically inserted between beats and at chapter endings. You can also manually insert scene breaks using the <strong>***</strong> button in the toolbar.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128218;</div>
        <div class="help-step-content">
          <h3>Book Structure &amp; Outlines</h3>
          <p>Define your book's total word count goal, number of chapters, title, and subtitle in <strong>Setup Book</strong>. Choose from narrative structure templates (Three-Act, Hero's Journey, Seven-Point, Kishoutenketsu) or create custom outlines. AI generates detailed ~200-250 word outlines per chapter based on your characters, notes, and structure.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128100;</div>
        <div class="help-step-content">
          <h3>Character Profiles</h3>
          <p>Create detailed character profiles with name, role, description, motivation, character arc, and personality traits. Character data is automatically included as context when generating prose, ensuring consistency. Access via the <strong>Characters</strong> tab in the sidebar.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128221;</div>
        <div class="help-step-content">
          <h3>Notes &amp; Research</h3>
          <p>Organize story foundation with categorized notes: <strong>General</strong>, <strong>Worldbuilding</strong>, <strong>Research</strong>, and <strong>Plot</strong>. All notes are fed to the AI as context during generation. Access via the <strong>Notes</strong> tab in the sidebar.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#127912;</div>
        <div class="help-step-content">
          <h3>Genre &amp; Voice Settings</h3>
          <p>Choose from 20+ literary genres with specialized prose style rules. Select a narrative voice/POV (first-person, third-limited, deep POV, stream-of-consciousness, and more). Genre and voice settings are saved per project and guide all AI generation. Configure in <strong>Settings &gt; Project Settings</strong>.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128248;</div>
        <div class="help-step-content">
          <h3>AI Book Cover</h3>
          <p>Generate AI-powered book covers based on your story content and genre. Uses Hugging Face Stable Diffusion / FLUX models. Covers display your book title and optional subtitle. Requires a free Hugging Face API token (configured in Settings). Regenerate as many times as needed.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#8681;</div>
        <div class="help-step-content">
          <h3>Export Formats</h3>
          <p>Export your manuscript in multiple formats:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li><strong>Standard Manuscript</strong> (Shunn format) with H1 chapter headings for KDP/agent submissions</li>
            <li><strong>Styled HTML</strong> for ebook formatting with proper chapter headings</li>
            <li><strong>Plain Text</strong> for universal compatibility</li>
            <li><strong>JSON Backup</strong> with all project data for backup and transfer</li>
            <li><strong>Cover Image</strong> download separately</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128274;</div>
        <div class="help-step-content">
          <h3>Writing Quality Rules</h3>
          <p>Genesis 2 enforces strict quality rules to produce publication-ready prose:</p>
          <ul style="margin:8px 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">
            <li><strong>Em dashes are banned</strong> from all generated text (they signal AI writing and format poorly in published works)</li>
            <li>AI writing patterns are detected and penalized in scoring</li>
            <li>PET phrases (cliched body reactions) are flagged and rewritten</li>
            <li>Show-don't-tell is enforced over exposition</li>
            <li>Genre-specific style rules maintain consistency</li>
          </ul>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128736;</div>
        <div class="help-step-content">
          <h3>Continue Writing &amp; Write to Goal</h3>
          <p>After each generation, use <strong>+1,000</strong>, <strong>+2,000</strong>, or <strong>+3,000</strong> buttons to continue writing. <strong>Write to Goal</strong> automatically generates prose until your project's word count target is reached, including a concluding section. <strong>Rethink</strong> lets you revise a chapter's outline before continuing.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#128187;</div>
        <div class="help-step-content">
          <h3>Multi-User &amp; Cloud Sync</h3>
          <p>Support for multiple users on a single device. Projects are stored in Firebase Firestore (cloud) and IndexedDB (local). Auto-save ensures no work is lost. Switch between users and projects from the home screen.</p>
        </div>
      </div>

      <div class="help-step">
        <div class="help-step-number">&#127919;</div>
        <div class="help-step-content">
          <h3>Daily Writing Goals</h3>
          <p>Set a daily word count target in Settings. Progress is tracked in the status bar and resets each day at midnight. Build a consistent writing habit by setting achievable daily goals.</p>
        </div>
      </div>

      <div style="background:var(--bg-secondary);border-radius:var(--radius-md);padding:16px;margin-top:20px;">
        <h3 style="font-size:0.85rem;font-weight:600;color:var(--accent-primary);margin-bottom:8px;">Keyboard Shortcuts</h3>
        <ul style="margin:0 0 0 20px;font-size:0.85rem;color:var(--text-secondary);line-height:1.8;">
          <li><strong>Cmd/Ctrl + B</strong> — Bold text</li>
          <li><strong>Cmd/Ctrl + I</strong> — Italic text</li>
          <li><strong>Cmd/Ctrl + Z</strong> — Undo</li>
          <li><strong>Cmd/Ctrl + Shift + Z</strong> — Redo</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-primary" id="btn-help-close" style="padding:12px 48px;">Close</button>
    </div>
  </div>
</div>

<!-- ===== Translation Modal ===== -->
<div class="modal-overlay" id="modal-translation" style="display:none;">
  <div class="modal modal-lg" style="max-width:680px;">
    <div class="modal-header">
      <h2>Translation Settings</h2>
      <button class="modal-close" data-close="modal-translation">&times;</button>
    </div>
    <div class="modal-body" style="max-height:75vh;overflow-y:auto;">

      <!-- Step 1: Language & Country -->
      <div class="translation-step">
        <h3 style="font-size:0.95rem;margin-bottom:8px;">Source &amp; Target</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label class="form-label">Source Language</label>
            <select class="form-input" id="trans-source-lang">
              <option value="en-US">English (United States)</option>
              <option value="en-GB">English (United Kingdom)</option>
              <option value="en-AU">English (Australia)</option>
            </select>
          </div>
          <div>
            <label class="form-label">Target Language</label>
            <select class="form-input" id="trans-target-lang">
              <option value="">&mdash; Select &mdash;</option>
              <option value="es-ES">Spanish (Spain)</option>
              <option value="es-MX">Spanish (Mexico)</option>
              <option value="es-AR">Spanish (Argentina)</option>
              <option value="fr-FR">French (France)</option>
              <option value="fr-CA">French (Canada)</option>
              <option value="it-IT">Italian (Italy)</option>
              <option value="de-DE">German (Germany)</option>
              <option value="de-AT">German (Austria)</option>
              <option value="pt-BR">Portuguese (Brazil)</option>
              <option value="pt-PT">Portuguese (Portugal)</option>
              <option value="ja-JP">Japanese (Japan)</option>
              <option value="ko-KR">Korean (South Korea)</option>
              <option value="zh-CN">Chinese (Simplified)</option>
              <option value="nl-NL">Dutch (Netherlands)</option>
              <option value="sv-SE">Swedish (Sweden)</option>
              <option value="pl-PL">Polish (Poland)</option>
              <option value="ru-RU">Russian (Russia)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 2: Cultural Adaptation Options -->
      <div class="translation-step" style="margin-top:16px;">
        <h3 style="font-size:0.95rem;margin-bottom:4px;">Cultural Adaptation</h3>
        <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:10px;">
          Choose how deeply to adapt the story for the target culture.
          &ldquo;Translate&rdquo; keeps original references. &ldquo;Adapt&rdquo; replaces them with culturally equivalent alternatives.
        </p>

        <div class="translation-options">

          <!-- Character Names -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-names">
                <span class="trans-toggle-label">Adapt Character Names</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Translate or culturally adapt character names to the target language.
              <em>Example: &ldquo;William Ford&rdquo; &rarr; &ldquo;Guglielmo Fordi&rdquo; (Italian) or keep original.</em>
            </p>
            <div class="trans-option-detail" id="trans-names-detail" style="display:none;">
              <select class="form-input form-input-sm" id="trans-names-mode">
                <option value="translate">Translate names to local equivalents (William &rarr; Guglielmo)</option>
                <option value="phonetic">Adapt spelling for local pronunciation (William &rarr; Guillem)</option>
                <option value="keep-first">Keep first names, translate surnames only</option>
              </select>
            </div>
          </div>

          <!-- Locations -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-locations">
                <span class="trans-toggle-label">Adapt Locations &amp; Settings</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Replace locations with culturally equivalent places in the target country.
              AI will research equivalent communities, landmarks, and venues.
              <em>Example: &ldquo;Palm Beach, Florida&rdquo; &rarr; &ldquo;Portofino, Liguria&rdquo; (Italian)</em>
            </p>
            <div class="trans-option-detail" id="trans-locations-detail" style="display:none;">
              <select class="form-input form-input-sm" id="trans-locations-mode">
                <option value="equivalent">Find culturally equivalent locations (same social status, climate, character)</option>
                <option value="same-country-translate">Keep locations, translate place names only</option>
                <option value="relocate-full">Fully relocate the story to the target country</option>
              </select>
            </div>
          </div>

          <!-- Vehicles, Brands, Products -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-brands">
                <span class="trans-toggle-label">Adapt Vehicles, Brands &amp; Products</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Replace brand names, car models, and products with locally recognized equivalents.
              <em>Example: &ldquo;Honda Accord&rdquo; &rarr; &ldquo;Fiat Panda&rdquo; (Italy), &ldquo;Walmart&rdquo; &rarr; &ldquo;Carrefour&rdquo; (France)</em>
            </p>
          </div>

          <!-- Currency & Measurements -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-units" checked>
                <span class="trans-toggle-label">Convert Currency &amp; Measurements</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Convert dollars to local currency, miles to kilometers, Fahrenheit to Celsius, etc.
              Amounts will be adjusted for approximate economic equivalence.
              <em>Example: &ldquo;$50&rdquo; &rarr; &ldquo;&euro;45&rdquo;, &ldquo;80 acres&rdquo; &rarr; &ldquo;32 hectares&rdquo;</em>
            </p>
          </div>

          <!-- Food & Cuisine -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-food">
                <span class="trans-toggle-label">Adapt Food &amp; Cuisine References</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Replace dishes and ingredients with local equivalents that carry the same cultural weight.
              <em>Example: &ldquo;meatloaf and mashed potatoes&rdquo; &rarr; &ldquo;polpettone con pur&egrave;&rdquo; (Italy)</em>
            </p>
          </div>

          <!-- Cultural References -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-culture">
                <span class="trans-toggle-label">Adapt Cultural References</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Adapt holidays, customs, institutions, historical references, and social norms.
              <em>Example: &ldquo;Thanksgiving dinner&rdquo; &rarr; &ldquo;pranzo di Natale&rdquo; (Italy)</em>
            </p>
          </div>

          <!-- Register / Formality -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-register" checked>
                <span class="trans-toggle-label">Manage Formal/Informal Register</span>
              </label>
            </div>
            <p class="trans-option-desc">
              In languages with formal/informal address (tu/vous, t&uacute;/usted, du/Sie),
              AI will choose the appropriate register based on character relationships.
            </p>
            <div class="trans-option-detail" id="trans-register-detail" style="display:none;">
              <select class="form-input form-input-sm" id="trans-register-mode">
                <option value="contextual">AI determines based on character relationships</option>
                <option value="formal">Default to formal (vous/usted/Sie/Lei)</option>
                <option value="informal">Default to informal (tu/t&uacute;/du/tu)</option>
              </select>
            </div>
          </div>

          <!-- Idioms & Expressions -->
          <div class="trans-option">
            <div class="trans-option-header">
              <label class="trans-toggle">
                <input type="checkbox" id="trans-adapt-idioms" checked>
                <span class="trans-toggle-label">Adapt Idioms &amp; Expressions</span>
              </label>
            </div>
            <p class="trans-option-desc">
              Replace English idioms with equivalent expressions in the target language
              rather than translating literally.
              <em>Example: &ldquo;raining cats and dogs&rdquo; &rarr; &ldquo;piove a catinelle&rdquo; (Italian)</em>
            </p>
          </div>

        </div>
      </div>

      <!-- Step 3: Scope -->
      <div class="translation-step" style="margin-top:16px;">
        <h3 style="font-size:0.95rem;margin-bottom:8px;">What to Translate</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <label class="trans-scope-option">
            <input type="radio" name="trans-scope" value="current-chapter" checked>
            <span>Current Chapter Only</span>
          </label>
          <label class="trans-scope-option">
            <input type="radio" name="trans-scope" value="all-chapters">
            <span>All Chapters</span>
          </label>
          <label class="trans-scope-option">
            <input type="radio" name="trans-scope" value="selection">
            <span>Selected Text Only</span>
          </label>
        </div>
      </div>

    </div>
    <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border-color);">
      <button class="btn" data-close="modal-translation">Cancel</button>
      <button class="btn btn-primary" id="btn-start-translation" disabled>Begin Translation</button>
    </div>
  </div>
</div>

<!-- ═══ Localization Review Modal ═══ -->
<div id="localization-modal" class="localization-overlay" style="display:none;">
  <div class="localization-container">
    <div class="localization-header">
      <h3 id="localization-title">Cultural Localization Review</h3>
      <p id="localization-subtitle" class="localization-subtitle">
        Review AI-suggested cultural adaptations before translating
      </p>
    </div>

    <div class="localization-progress">
      <span id="localization-lang-label">Italian</span>
      <span id="localization-count">0 of 0 items</span>
    </div>

    <div class="localization-items" id="localization-items-list">
      <!-- Populated dynamically -->
    </div>

    <div class="localization-footer">
      <button class="btn btn-secondary" id="btn-loc-approve-all">Approve All Suggestions</button>
      <button class="btn btn-secondary" id="btn-loc-skip-all">Skip Localization (Translate As-Is)</button>
      <button class="btn btn-primary" id="btn-loc-apply">Apply Selections &amp; Translate</button>
    </div>
  </div>
</div>

<!-- ═══ Translation Side-by-Side View ═══ -->
<div id="translation-split-view" class="translation-split-overlay" style="display:none;">
  <div class="translation-split-header">
    <h3 id="translation-split-title">Translation Preview</h3>
    <div class="translation-split-actions">
      <select id="translation-lang-select" class="translation-lang-dropdown">
        <option value="">Select language…</option>
      </select>
      <button class="btn btn-sm" id="btn-export-translation-docx" title="Export as DOCX">Export DOCX</button>
      <button class="btn btn-sm btn-close-split" id="btn-close-split" title="Close">&#10005;</button>
    </div>
  </div>
  <div class="translation-split-body">
    <div class="translation-pane translation-pane-original">
      <div class="translation-pane-label">Original</div>
      <div class="translation-pane-content" id="split-original-content"></div>
    </div>
    <div class="translation-divider"></div>
    <div class="translation-pane translation-pane-translated">
      <div class="translation-pane-label" id="split-translated-label">Translation</div>
      <div class="translation-pane-content" id="split-translated-content"></div>
    </div>
  </div>
</div>

<!-- Flyout Tooltip -->
<div id="tooltip-flyout"><div class="tooltip-body"></div></div>

<!-- DOCX generation library for manuscript export -->
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
<!-- DOCX reading library for manuscript import -->
<script src="https://unpkg.com/mammoth@1.8.0/mammoth.browser.min.js"></script>
<!-- ZIP library for EPUB import -->
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<!-- Puter.js loaded lazily by generate.js when AI image features are used -->
<script src="js/genres.js"></script>
<script type="module" src="js/app.js"></script>

</body>
</html>
